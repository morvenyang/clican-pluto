KISSY.add("tc/core/rule",function(e,t,n,r){var i="done",s="selfUpdate",o="parentUpdate",u={groups:["global"],parents:[]},a={},f=function(){return 0},l=function(t,n){return e.each(relations[t],function(t){if(e.inArray(t,n))return;l(t,n),n.push(t)}),n},f=function(){return 0},c=function(t,n,o){var f=this,l=[],p=[];f.name=e.isString(t)?t:"",f.calc=n,f.id=e.guid(),f.__cache=[],f.__parents={},o=e.merge(o,{vars:[e.merge({},o&&o.vars)]}),e.each(o.groups||p,function(e){e&&p.push(e)}),o.groups=p.length===0?u.groups:p,e.mix(f,e.merge(u,o));var d=f.parents.length;while(d--)f.vars.unshift(0),f.__parents[f.parents[d]]={};e.each(f.groups,function(e){e&&(l.push(e+"/update"),a[e]===r&&(a[e]=[]),a[e].push(f))}),c.on(l.join(" "),function(e){h.call(f,e)}),f.detach(i).on(i,function(){var t=!1;if(f.__cache[1]!==f.result||f.__cache[1]+f.result===0)t=!0,f.result=f.__cache[1],c.async?(f.done&&f.done.cancel(),f.done=e.later(function(t){e.each(f.groups,function(e){c.fire(e+"/update",{target:f,result:f.result})})},100,!1,f)):e.each(f.groups,function(e){c.fire(e+"/update",{target:f,result:f.result})});f.fire(s,{result:f.result,changed:t})})};e.augment(c,e.EventTarget,{result:0,update:function(t,n){var o=this;e.isFunction(t)&&(n=t,t={}),e.mix(o.vars[o.vars.length-1],t);if(o.__cache[0]!==o.vars||o.__cache[1]===r)o.__cache[1]=o.calc.apply(o,o.vars)||0;return n&&o.detach(s).on(s,function(e){n(e.result)}),o.fire(i),o}});var h=function(t){var n=this;if(e.inArray(t.target.name,n.parents)){if(t.target===n)return;console.log("[rule]: %s (%s) => %s. |%s|",t.target.name,t.result,n.name,t.type.replace("/update","")),n.__parents[t.target.name]=n.__parents[t.target.name]||{},n.__parents[t.target.name][t.target.id]=t.result;var r=n.fire(o,{name:t.target.name,parent:n.__parents[t.target.name]})||t.result;n.vars[e.indexOf(t.target.name,n.parents)]=r,n.update()}};return e.mix(c,e.EventTarget),c.add=function(e,t,n){return new c(e,t||f,n)},c.groups=a,c.sum=function(e){var t=0;for(var n in e)t+=e[n];return t},c.cache={},c.async=!0,console.on("log warn",function(e){this.decorate(e.args,"rule","color: green")}),c},{requires:["event","json"]}),KISSY.add("tc/core/profile",function(e){var t={};return e.mix(t,{cache:{},time:function(e){if(!e)return;this.cache[e]=[+(new Date)]},timeEnd:function(e){if(!e in this.cache)return;var t=+(new Date);this.cache[e][2]=t-this.cache[e][0]},report:function(){var e=[];for(var t in this.cache)e.push(t+": "+this.cache[t][2]);return e.join("\r\n")}}),t}),KISSY.add("tc/cart/order",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g={_init:function(){var n=e.mix(this,this.config),r=n.orderId,i=n.cartId,s=n.crossId,g=n.orderEl,y=[r],b=e.one("em.J_ShopTotal",n.orderEl);h.time("order-other:"+r),n.shopPay=new f({shopPayEl:b,orderId:n.orderId,isB2c:t.attr(n.orderEl,"data-isb2c"),groups:y.concat(i)}),n.usePoint&&(n.shopPointBuy=new v({groups:y.concat(i)}));var w=!!s;if(w){if(!n.crossOrders[s]){var E=[];e.each(n.relations[s],function(e){E.push(e.replace("b_",""))}),n.crossOrders[s]=new m({crossShopPayEl:n.orderEl.next("tbody.cross-total"),crossId:s,cid:i,groups:y.concat(i).concat([s]),oids:E,initCrossShopPromo:n.crossShopPromotions})}n.crossPay=n.crossOrders[s]}else n.usePoint&&(n.ShopWinPointUI=new c({groups:y.concat(i)}));h.timeEnd("order-other:"+r),h.time("order-fareUI:"+r);var x=e.all("tr.item",g),T=[];x.each(function(t){var n=e.one(t).attr("data-lineid");T.push(n)}),n.fareUI=new l({orderEl:n.orderEl,fareEl:e.one("select.J_Fare",n.orderEl),fareSumEl:e.one("em.J_FareSum",n.orderEl),groups:y,promotion:n.promotion});var N=0;n.codReady=!0,h.timeEnd("order-fareUI:"+r),h.time("order-itemUI:"+r),n.items={};var C=0;n.listen("fare:toggle",function(t){e.inArray(t.oid,T)&&n.fareUI.toggle(t.type==="show")}),x.each(function(t){t=e.one(t);var i=t.attr("data-lineid");n.items[i]=new o({itemEl:t,itemId:i,orderId:r,promotion:n.promotion,service:n.service,usePoint:n.usePoint,from:n.from,isCrossShop:w}),++C===x.length&&(n.itemReady=!0)}),h.timeEnd("order-itemUI:"+r),d.lazyAdd(function(){n.memo=new a({memo:t.get("textarea.msgtosaler",n.orderEl),groups:y.concat(i)});var e=t.get("div.J_Inv",n.orderEl);e&&new u({invEl:e,groups:y.concat(i)})});var k="b_"+r;if(!w){h.time("order-promotion&fareUI:"+r);var L=e.one("em.J_ShopPromo_Result",n.orderEl.getDOMNode()),A=n.promotion.createPromo(k,e.one("div.J_ShopPromo",n.orderEl.getDOMNode()),y,"shopPromo");n.promotion.on(k+":change",function(e){if(n.ShopWinPointUI){var t=e.selectedBundle.point||0;n.ShopWinPointUI.updatePoint(t)}}),A.logic.rule.on("selfUpdate",function(e){p.html(L,(-e.result).toFixed(2),"shopPromo")}),A.logic.rule.update({discount:n.promotion.logic.getDiscount(k)}),h.timeEnd("order-promotion&fareUI:"+r)}n.service.createServices(k,e.one("div.servicearea",n.orderEl.getDOMNode()),y,"shopService"),n.listen(k+":serviceChange",function(t){n.service.createService(k,t.sid,e.one("div.servicearea",n.orderEl.getDOMNode()),y,"shopService")}),n.stepPay&&(n.stepPayInstance=n.stepPay.createStepPay(k,y.concat(i)))}};return g},{requires:["dom","event","ajax","json","tc/core/rule","tc/cart/item","tc/mods/invTitle/ui","tc/mods/memo/cart-ui","tc/mods/shopPay/cart-ui","tc/mods/fare/ui","tc/mods/winPoints/winPoint-ui","tc/core/profile","tc/core/domcache","tc/core/laterqueue","tc/mods/pointBuy/shopPointBuy","tc/mods/crossShop/ui"]}),KISSY.add("tc/cart/item",function(e,t,n,r,i,s,o,u,a,f,l){var c=function(e,t,n,r){e||(console.warn("cannot get item %s. groups: %s",n,r),e=t)},h={_init:function(){var i=e.mix(this,this.config),s=i.orderId,f=[i.itemId],h=e.one("em.J_ItemPrice",i.itemEl),p=e.one("input.J_Quantity",i.itemEl),d=e.one("em.J_ItemTotal",i.itemEl),v=h.html(),m=+e.trim(p.attr("data-max")),g=i.isCrossShop;c(h,0,"price",i.itemId),c(p,1,"quantity",i.itemId),a.time("---quantity:"+i.itemId),i.from!=="normal"||g||p.attr("type")==="hidden"?i.quantity=new u({quantityEl:p.getDOMNode(),groups:f}):i.quantity=new n({quantityEl:p.getDOMNode(),maxValue:m,groups:f}),a.timeEnd("---quantity:"+i.itemId),a.time("---itemPay&winPoint:"+i.itemId),new r({itemPayEl:d,itemId:i.itemId,groups:f.concat(s)});if(i.usePoint){i.itemWinPointsUI=new o({itemEl:i.itemEl,itemId:i.itemId,promotion:i.promotion,groups:f.concat(s)}),i.itemPointBuy=new l({groups:f.concat(s)});var y="b_"+s;i.promotion.on(y+":change",function(){var e=0;try{e=i.promotion.logic.data.orders[i.itemId].averageSum}catch(t){}i.itemWinPointsUI.logic.rule.update({averageSum:e})}),i.promotion.on(i.itemId+":change",function(e){if(i.usePoint){var t=0;try{t=e.selectedBundle.usedPoint}catch(e){}i.itemPointBuy.castPoint(t||0),i.itemWinPointsUI.logic.rule.update({pointBuy:t||0})}})}a.timeEnd("---itemPay&winPoint:"+i.itemId),a.time("---itemInfo:"+i.itemId),i.itemInfo=new t({price:v,groups:f}),a.timeEnd("---itemInfo:"+i.itemId),a.time("---service:"+i.itemId);var b=!!e.one("li.substep",i.itemEl.parent());i.service.createServices(i.itemId,b?e.all("li.servicearea",i.itemEl.parent()):e.one("td.servicearea",i.itemEl.next(".item-service")),f.concat(s),"itemService"),i.listen(i.itemId+":serviceChange",function(t){i.service.createService(i.itemId,t.sid,b?e.all("li.servicearea",i.itemEl.parent()):e.one("td.servicearea",i.itemEl.next(".item-service")),f.concat(s),"itemService")}),a.timeEnd("---service:"+i.itemId),g||(a.time("---promotion:"+i.itemId),i.promotion.createPromo(i.itemId,e.one("div.J_Promotion",i.itemEl),f,"itemPromo"),a.timeEnd("---promotion:"+i.itemId));var w=!0;i.quantity.logic.on("change",function(e){if(w){w=!1;return}i.promotion.logic.updateAmount(i.itemId,e.quantity),i.broadcast("getPromotion",{oid:i.itemId,quantity:e.quantity,from:"changeamount"})})}};return h},{requires:["tc/mods/itemInfo/ui","tc/mods/quantity/operation-ui","tc/mods/itemPay/ui","tc/core/rule","tc/mods/promotions/cart-ui","tc/mods/winPoints/itemWinPoint-ui","tc/mods/quantity/static-ui","tc/core/profile","tc/core/laterqueue","tc/mods/pointBuy/itemPointBuy"]}),KISSY.add("tc/mods/itemInfo/ui",function(e,t){var n={};return n._init=function(){var e=this;e.logic=new t(e.config)},n},{requires:["./item"]}),KISSY.add("tc/mods/itemInfo/item",function(e,t){var n={};return n._init=function(){var n=e.mix(this,this.config);n.rule=t.add("itemPrice",function(e){return e.price},{vars:{price:n.price},groups:n.groups}),n.rule.update()},n},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/quantity/operation-ui",function(e,t,n,r,i){var s={},o={create:function(e,n){var r;return n=="minus"?(r=t.create('<a href="#" class="minus">-</a>'),e.value===1&&t.addClass(r,"c2c-oper-disable"),t.insertBefore(r,e)):(r=t.create('<a href="#" class="plus">+</a>'),t.insertAfter(r,e)),r}};return s._init=function(){var s=e.mix(this,this.config),u=s.quantityEl,a=s.maxValue,f={type:"normal",quantity:e.trim(u.value),maxQuantity:a,groups:this.groups},l=s.logic=new r(f),c=l.validates;c.quantityNum.on("error",function(t){i.error(u.parentNode,t.msg),e.later(function(){u.value=1,l.change({quantity:e.trim(u.value)}),i.clearErr(u.parentNode,t.msg)},3e3,!1)}).on("success",function(e){i.clearErr(u.parentNode,e.msg)}),c.quantityCompare.on("error",function(){i.error(u.parentNode,"最多只能购买"+a+"件"),u.value=a,l.change({quantity:e.trim(u.value)})}).on("success",function(){u.value<a&&i.clearErr(u.parentNode,"最多只能购买"+a+"件")});var h=o.create(u,"minus"),p=o.create(u,"plus");n.on(u,"keyup",function(){l.change({quantity:e.trim(u.value)}),u.value<=1?t.addClass(h,"c2c-oper-disable"):(t.hasClass(h,"c2c-oper-disable")&&t.removeClass(h,"c2c-oper-disable"),t.hasClass(h,"c2c-oper-hover")||t.addClass(h,"c2c-oper-hover"))}),n.on(h,"click",function(n){n.preventDefault();if(t.hasClass(this,"c2c-oper-disable"))return;u.value>0&&(u.value=+u.value-1,u.value<=1&&t.addClass(h,"c2c-oper-disable"),l.change({quantity:e.trim(u.value)}))}),n.on(p,"click",function(n){n.preventDefault();if(t.hasClass(this,"c2c-oper-disable"))return;u.value=+u.value+1,u.value>1&&(t.hasClass(h,"c2c-oper-disable")&&t.removeClass(h,"c2c-oper-disable"),t.hasClass(h,"c2c-oper-hover")||t.addClass(h,"c2c-oper-hover")),l.change({quantity:e.trim(u.value)})}),n.on([h,p],"click",function(t){t.preventDefault();var n=e.one(h).parent().attr("data-point-url");s.broadcast("make-point",{url:n},["global"])}),t.addClass([h,p],"c2c-oper-default"),n.on([h,p],"mouseover mouseout",function(n){n.type==="mouseover"?(t.hasClass(h,"c2c-oper-disable")||t.addClass(h,"c2c-oper-hover"),t.hasClass(p,"c2c-oper-disable")||t.addClass(p,"c2c-oper-hover"),t.addClass(u,"c2c-text-hover")):(e.each([h,p],function(e){t.removeClass(e,"c2c-oper-hover")}),t.removeClass([h,p],"c2c-oper-hover"),t.removeClass(u,"c2c-text-hover"))}),n.on([h,p],"mouseover mouseout",function(e){t.hasClass(e.target,"c2c-oper-disable")||e.type==="mouseover"&&t.addClass(e.target,"c2c-oper-hover-important"),e.type==="mouseout"&&t.removeClass(e.target,"c2c-oper-hover-important")}),n.on(u,"focus blur",function(n){e.each([h,p],function(e){n.type==="focus"&&!t.hasClass(e,"c2c-oper-disable")?t.addClass(e,"c2c-oper-focus"):t.removeClass(e,"c2c-oper-focus")})}),n.on(u,"mouseover mouseout",function(n){e.each([h,p],function(e){n.type==="mouseover"&&!t.hasClass(e,"c2c-oper-disable")?t.addClass(e,"c2c-oper-hover"):t.removeClass(e,"c2c-oper-hover")})})},s},{requires:["dom","event","./quantity","tc/core/common"]}),KISSY.add("tc/mods/quantity/quantity",function(e,t,n,r,i){var s={};return s._init=function(){var i=this;i.validates={quantityNum:new n,quantityCompare:new r},i.setData(i.config),i.rule=t.add("quantity",function(e,t){return e*t.quantity},{parents:["itemPrice"],groups:i.groups,vars:{quantity:i.quantity}});var s=null;i.rule.on("selfUpdate",function(){s&&s.cancel(),s=e.later(function(){i.fire("change",{quantity:i.quantity}),i.broadcast("quantity-change",{quantity:i.quantity})},300)}),i.listen("global-test",function(){return i.test()},["global"])},s.setData=function(t){e.mix(this,t,!0)},s.test=function(){return this.maxQuantity===i||this.maxQuantity===""?this.validates.quantityNum.validate(this.quantity):this.validates.quantityNum.validate(this.quantity)&&this.validates.quantityCompare.validate(this.quantity,this.maxQuantity)},s.change=function(e){var t=this;return t.setData(e),t.test()?(console.log("[quantity]: Updating quantity: %s",t.quantity),t.rule.update({quantity:t.quantity}),!0):!1},s},{requires:["tc/core/rule","tc/form/number","tc/form/compareNum"]}),KISSY.add("tc/form/number",function(e,t){return t.add("number",function(e,t){return/^\d+$/.test(e)&&+e>0&&+e<(t||Number.MAX_VALUE)},"购买数量必须为大于0的整数")},{requires:["tc/core/form"]}),KISSY.add("tc/core/form",function(e,t){var n={},r={},i=function(t){return e.isArray(t)?t:t.split(/[,\s]+/)},s=e.mix(e.EventTarget,{validate:function(){if(this.stop)return!0;var e=[].slice.call(arguments),t=!0;for(var r=0,i=this.name.length;r<i;r++)if(this.name[r]in n){t=n[this.name[r]].validate.apply(this,e);if(!t)break}this.name.length==1&&(r=0);var s=t?"success":"error";return console.log("[form]: %s validate result: %s, fired: %s.",this.name.join(","),t,s),this.fire(s,n[this.name[r]]),t},stop:!1,bind:function(){var t=[].slice.call(arguments),n=[],r=this,i={events:"blur",stopAtFirst:!1,haltAtFirst:!0,onBeforeValidate:function(){},onValidated:function(){}},s,o=i.haltAtFirst;e.isPlainObject(t[t.length-1])&&(i=e.merge(i,t.pop())),e.isFunction(t[t.length-1])&&(s=t.pop()),r.stop=i.stopAtFirst,e.Event.on(t,i.events,function(u){s&&s.apply(r,t),i.onBeforeValidate.apply(r,t),e.each(t,function(e,t){n[t]=e.value});var a=r.validate.apply(r,n);return r.stop=!1,i.onValidated.call(r,a,u),!a&&o&&u.halt(!0),a})}}),o={};return o.add=function(t,r,o,u){n[t]={validate:r||function(){return!0},msg:o||""};var a=function(t){this.config={},e.isObject(t)&&e.mix(this.config,t)},f={name:i(t),mixWith:function(){var n=[],r,s=[].slice.call(arguments);for(var o=0,u=s.length;o<u;o++){r=s[o],e.isFunction(r)&&(n=(new r).name),e.isString(r)&&!e.inArray(t,this.name)&&(n=i(t));for(var a=0,f=n.length;a<f;a++)this.name.push(n[a])}return this}};return e.augment(e.isFunction(u)&&u||a,f,s)},console.on("log",function(e){this.decorate(e.args,"form","background: #d5ffc4")}),o}),KISSY.add("tc/form/compareNum",function(e,t){return t.add("compareNum",function(e,t){return e||(e=0),parseInt(e)<=(t===Infinity?t:parseInt(t))},"您使用的商城积分点数超过了该次订单确认允许使用的最大商城积分点数")},{requires:["tc/core/form"]}),KISSY.add("tc/core/common",function(e,t){Number.prototype.toFixed||(Number.prototype.toFixed=function(e){var t=Math.pow(10,e||0),n=String(Math.round(this*t)/t),r=n.split(".")[1],i=0;r?i=r.length:e!=i&&(n+=".");for(var s=0;s<e-i;s++)n+="0";return n});var n=function(n,r){if(!n)return;r?e.all(".label-error",n).each(function(e){e.html()==r&&e.hide()}):t.hide(t.query(".label-error",n))},r=function(e,r){n(e),e=t.get(e);if(!e)return;var i=t.get(".label-error",e)||function(){var n=document.createElement("div");return t.addClass(n,"label-error"),e.appendChild(n),n}();t.show(i),t.html(i,r||"")},i=function(t,n){s(t);var r=e.one(".msg",t)||e.one('<div class="msg"><p class="error"></p></div>').appendTo(t);e.one(".error",r).text(n).parent().show()},s=function(t,n){n?e.all(".msg",t).each(function(t){e.one(".error",t).text()==n&&t.hide()}):e.all(".msg",t).hide()};return{block:function(e,t){var n=/^function\b\s*([\$\S]*)\s*\(/,r=/[^{]*\{([\d\D]*)\}$/,i=/[^\(]*\(([^\)]*)\)[\d\D]*/;return t=(t||"body").toLowerCase(),e=e.toString(),t=="body"?e.replace(r,"$1").replace(/^\s*|\s*$/g,""):t=="param"?(t=e.replace(i,"$1"))?t.split(/[,\s]+/):[]:t=="name"?e.match(n)[1]:t=="anonymous"?Function.apply(this,arguments.callee(e,"param").concat(arguments.callee(e,"body"))):"Block() with bad arguments."},parseBoolean:function(e){return e&&e!="false"},error:r,clearErr:n,dplError:i,clearDplErr:s}},{requires:["dom"]}),KISSY.add("tc/mods/itemPay/ui",function(e,t,n,r){var i={};return i._init=function(){var n=e.mix(this,this.config);n.logic=new t(n.config),n.logic.rule.on("selfUpdate",function(e){r.html(n.itemPayEl,e.result.toFixed(2))})},i},{requires:["./itemPay","dom","tc/core/domcache"]}),KISSY.add("tc/mods/itemPay/itemPay",function(e,t){var n={};return n._init=function(){var n=e.mix(this,this.config);n.rule=t.add("itemPay",function(e,t){return console.log("[update itemPay]: (quantity)%s, (itemPromo)%s",e,t),e+t},{parents:["quantity","itemPromo"],groups:n.groups})},n},{requires:["tc/core/rule"]}),KISSY.add("tc/core/domcache",function(e,t){var n={},r={},i=300,s="data-domcache",o=0,u=0;return e.mix(n,{html:function(t,n,o){if(!t)return;t.getDOMNode&&(t=t.getDOMNode());var u=t.getAttribute(s);u||(u=e.guid(),t.setAttribute(s,u)),r[u]&&r[u].cancel(),r[u]=e.later(function(){t.innerHTML=n},i)}}),n},{requires:["dom"]}),KISSY.add("tc/mods/promotions/cart-ui",function(e,t,n,r,i,s,o,u,a,f,l){var c={};c.objects={},c._init=function(){var t=e.mix(this,this.config);t.logic=new f({data:t.data,config:t.config}),t.logic.initPromoBundlesAndCouples()},c.update=function(t,n,r){var i=this;i.request&&i.request.abort(),i.fire("promotion-start"),console.log("[promo]: Updating Promotion(%s), %s",n,t),e.each(i.logic.tempOrders,function(t,n){e.mix(i.logic.data.orders[n],t)}),i.logic.tempOrders={};var s=e.clone(i.logic.data.orders);if(s)for(var o in s)delete s[o].bundles,s[o].parent==="cross_id"&&delete s[o].parent,s[o].divisionCode&&r&&(s[o].divisionCode=r);var f=a.stringify(s);if(f==="{}"){i.fire("promotion-error",{method:n});return}i.request=u({type:"POST",url:i.api,data:{order:t,promodata:f,from:i.from||"unity",m:n||"changeamount",t:e.now()},success:function(e){try{e=a.parse(e)}catch(t){console.error("[promo]: Data Parse Error, %s",t.message),e={},i.fire("promotion-error",{method:n})}e.result==="success"?i.logic.merge(e.data):(console.error("[promo]: Promotion Request Error, %s",e.message),i.logic.resetAll(),i.fire("promotion-error",{method:n}))},error:function(){i.logic.resetAll(),i.request.status==0&&(console.error("[promo]: Promotion Request Error, %s, Errno: %s",t,i.request.status),i.fire("promotion-error",{method:n}))},complete:function(){i.updatePromo(),i.fire("promotion-complete",{method:n})},timeout:5e3})},c.createPromo=function(e,t,n,r){var i=this,s=i.logic.base(r),o=i.logic.data,u=o.orders[e],a=i.objects;return a[e]=a[e]||{},a[e].container=t,a[e].logic||(a[e].logic=new s(n||i.groups)),a[e].ui=i.renderMenu(a[e].container,a[e].ui,u&&u.bundles,u&&u.bundle,e,!0),a[e]},c.updatePromo=function(){var t=this,n=t.logic.data.orders;if(!n)return;var r=[],i=[],s;e.each(t.objects,function(e,t){var s={obj:e,oid:t};n[t]&&(n[t].parent!=="cross_id"?r.push(s):i.push(s))}),s=r.concat(i),e.each(s,function(e){var r=e.obj,i=e.oid;console.log("[promo]: Refresh Promotion Menu. %s",i);var s=n[i];try{r.ui=t.renderMenu(r.container,r.ui,s.bundles,s.bundle,i)}catch(o){console.log("[promo]: RenderMenu Error %s: %s",o.lineNumber,o.message)}})},c.renderMenu=function(n,i,s,u,a,f){var l=this;if(!(n=e.one(n))){console.error("[promo]: Promotion Target Element Not Found");return}if(l.logic.data.orders[a]){s=l.logic.getBundles(a);if(a.indexOf("b_")>-1){var c=[];for(var h in s)c.push(h)}}l.fire(a+":change",{selectedBundle:s&&s[u]||{}});var p=e.one("input.J_PremiumItem",n.parent("td"));if(u&&s&&l.logic.data.orders[a].isExtraItem){var d=s[u];n.html(d.title),l.objects[a].logic.rule.update({discount:l.logic.getDiscount(a,u)}),p&&p.val(l.logic.data.orders[a].extraPrice+":"+l.logic.data.orders[a].fromIdValue);return}p&&p.val("");var v=!l.logic.data.orders[a]||!l.logic.data.orders[a].parent||"cross_id"===l.logic.data.orders[a].parent;if(!u&&e.isEmptyObject(s)){l.objects[a].logic.rule.update({discount:l.logic.getDiscount(a)}),n.html("无优惠"),v&&t.hide(t.parent(n,"div.shoparea"));return}v&&t.show(t.parent(n,"div.shoparea"));if(!i){n.html("");var m=r(e.substitute(['<select name="bundleList_{oid}">','<option value="{selected}"></option>',"</select>"].join(""),{oid:a,selected:u}));i=new o.Select.decorate(m,{prefixCls:"c2c-"}),i.on("afterSelectedItemChange",function(e){var t=this.get("selectedIndex"),n=l.logic.data.orders[a],r=e.target.value;console.log("[promo]: Promotion(%s) changed from %s to %s",a,n.bundle,r),n.parent&&n.bundle!==r&&(l.logic.updateOrder(a,r),l.update(a,"changebundle")),l.objects[a].logic.rule.update({discount:l.logic.getDiscount(a,r)}),l.fire(a+":change",{selectedBundle:s[r]||{}}),i.get("selectedItem")&&i.get("selectedItem").set("value",l.logic.getCouples(a)),i.set("selectedIndex",t);var o=i.get("el").parent().attr("data-point-url");l.broadcast("make-point",{url:o})})}i.removeItems(!0);var g=!1;if(!u||s[u].optional==="true")i.addItem(new o.Option({prefixCls:"c2c-",value:"",content:"不使用优惠"})),g=!0;e.each(s||{},function(e,t){i.addItem(new o.Option({prefixCls:"c2c-",value:t,content:e.title}))});var y=0;if(u){y=g?1:0;for(var b in s){if(b===u)break;y++}}else y=0;return i.set("selectedIndex",y),l.objects[a].logic.rule.update({discount:l.logic.getDiscount(a,u)}),i.get("selectedItem")&&i.get("selectedItem").set("value",l.logic.getCouples(a)),i.set("selectedIndex",y),i.isInDOM||(t.appendTo(i.get("menu"),n),i.isInDOM=!0),l.showDesc(n,l.logic.getDesc(a),a),l.showGift(n,l.logic.getGift(a)),i};var h=i(['<p class="c2c-gift-container">',"{{#each gifts as gift}}",'{{#if gift.href&&gift.href!="javascript:void(0)"}}','<a href="{{gift.href}}" target="_blank">{{gift.desc}}</a> ',"{{#else}}",'<em title="{{gift.desc}}">{{gift.desc}}</em> ',"{{/if}}","{{/each}}","</p>"].join("")).render;c.showGift=function(t,n){t=e.one(t);var i=e.one(".c2c-gift-container",t.getDOMNode());i&&i.remove();if(!n)return;var s=[];e.each(n.split(";"),function(e){e=e.split("|"),s.push({href:e[1]?e[0]:"javascript:void(0)",desc:e[1]?e[1]:e[0]})}),i=r(h({gifts:s})).appendTo(t)};var p=i(['<div class="c2c-desc-container">','<span class="c2c-desc-trigger">优惠详情</span>',"</div>"].join("")).render,d=i(['<div id="J_Desc_promo_{{oid}}" class="c2c-desc" style="visibility: hidden; background: white;">','<div class="kd-popup">','<div class="box">','<div class="bd">{{desc}}</div>',"</div>",'<i class="top"></i>',"</div>","</div>"].join("")).render;return c.showDesc=function(t,n,i){t=e.one(t);var o=e.one("div.c2c-desc-container",t.getDOMNode());o&&o.remove();var u=e.one(document.getElementById("J_Desc_promo_"+i));u&&u.remove();if(!n)return;o=r(p({desc:n})).appendTo(t),u=r(d({desc:n,oid:i})).appendTo(document.body);var a=o.getDOMNode(),f={node:e.one("span.c2c-desc-trigger",a),points:["bl","tl"],offset:[-20,10]};(new s.Popup(u,{trigger:e.one("span.c2c-desc-trigger",a),triggerType:"mouse",align:f})).on("beforeVisibleChange",function(t){t.attrName==="visible"&&t.target.set("align",e.merge(f))})},c.recoverPromotion=function(t,n){var r=this,i=r.logic.data.orders[t],s=r.objects[t].ui,o=-1;e.each(s.get("children"),function(e,t){e.get("value")==n&&(o=t)}),o>-1&&(s.set("selectedIndex",o),s.fire("afterSelectedItemChange"))},c},{requires:["dom","event","node","template","overlay","tc/dpl/dropDown","ajax","json","./promotion","tc/core/laterqueue"]}),KISSY.add("tc/dpl/dropDown",function(e,t,n,r,i){var s=!0;return s?n:t},{requires:["menubutton","./emulate","ua"]}),KISSY.add("tc/dpl/emulate",function(e,t){var n=e.all,r={_init:function(){}};return r.Select={decorate:function(t,i){var s=this;s.options=[],t=n(t)[0];var o={set:function(e,t){o["_set_"+e]?o["_set_"+e](t):console.error("not support")},_set_selectedIndex:function(e){t.options.length<=e&&(e=t.options.length-1),e!=-1&&(t.options[e].selected=!0)},_get_selectedItem:function(){if(t.selectedIndex==-1)return null;var e=t.options;for(var n=0;n<e.length;n++)if(e[n].selected)return new r.Option({o:e[n]})},_set_selectedItem:function(e){var n=t.options;for(var r=0;r<n.length;r++)n[r].selected=e.o==n[r]},_get_value:function(){return n(t).val()},_get_content:function(){return t.selectedIndex==-1?"":t.options[t.selectedIndex].text},_get_menu:function(){return t},_get_el:function(){return e.one(t)},_get_selectedIndex:function(){return t.selectedIndex},_get_children:function(){return s.options},get:function(e){if(o["_get_"+e])return o["_get_"+e](e);console.error("not support")},removeItems:function(){t.options.length=0,s.options=[]},addItem:function(e){t.options.add(e.o),s.options.push(e)},removeItem:function(n){var r=t.options,i=[],o=[];for(var u=0;u<r.length;u++)r[u]!=n.o&&i.push(r[u]);t.options.length=0,e.each(i,function(e){t.options.add(e)}),e.each(s.options,function(e){n.o!=e&&o.push(e)}),s.options=o},hide:function(){n(t).hide()},show:function(){n(t).show()},on:function(e,r){e==="afterSelectedItemChange"?n(t).on("change",r,o):e==="click"?n(t).on("click",r,o):e==="change"?n(t).on("change",r,o):console.error("on not support: %s",e)},fire:function(e){e==="afterSelectedItemChange"&&n(t).fire("change")},detach:function(e,r){e==="click"?n(t).detach("click",r,o):console.error("not support")},destroy:function(){n(t).detach(),n(t).remove()}};return o}},r.Option=function(e){e.o?this.o=e.o:this.o=new Option(e.content,e.value)},e.augment(r.Option,{get:function(e){var t=this;if(t["_get_"+e])return t["_get_"+e](e);console.error("not support")},_get_content:function(){return this.o.text},_get_value:function(){return this.o.value},set:function(e,t){var n=this;n["_set_"+e]?n["_set_"+e](t):console.error("not support")},_set_content:function(e){this.o.text=e},_set_value:function(e){this.o.value=e}}),r}),KISSY.add("tc/mods/promotions/promotion",function(e,t,n,r,i){var s=function(e){return function(t){var n=this;n.groups=t,n.disabled=!1,n.rule=new r(e||"promotion",function(e){return n.disabled?0:-parseInt(e.discount,10)/100},{vars:{discount:0},groups:n.groups})}},o={promos:{},orders:{},relation:{}},u={cross:"cross_id"},a=window.blacklist={},f={},l=function(t,n){if(a[t]&&e.inArray(n,a[t])){var r=e.indexOf(n,a[t]);a[t].splice(r,1)}},c=function(t,n,r){var i;if(!e.isString(t)){console.error("[promo]: Invalid OrderName(String): %s",t);return}i=t,t=o.orders[i];if(!e.isObject(t)){console.error("[promo]: Invalid Order Object: ",t);return}if(n==t.bundle&&!r)return;h(),console.log("[promo]: Updating Order: %s",i);var s=t.bundle;s&&e.each(s.split(";"),function(n){l(i,n),t.parent&&o.promos[n].once&&e.each(o.relation[t.parent],function(e){l(e,n)})}),t.bundle=n||null,e.each(t.bundles[s]&&t.bundles[s].promos,function(e){t.couple&&t.couple.length&&v(e,t.couple)}),t.couple=[];var u=[];t.bundles[t.bundle]&&e.each(t.bundles[t.bundle].promos,function(e){t.couple.push(d(e)),o.promos[e]&&o.promos[e].once&&o.promos[e].unused.length===0&&u.push(e)}),t.parent&&u.length&&e.each(o.relation[t.parent],function(e){m(e,o.orders[e],u,n)})},h=function(){e.each(o.promos,function(e){e.unused=e.unused||[],e.used=e.used||[]}),e.each(o.orders,function(t){t.couple=t.couple||[],t.bundles=t.bundles||{},e.isEmptyObject(t.bundles)&&(t.bundle=null),"isBundleItem"in t||(t.isBundleItem=!1),!t.cross&&!t.parent&&(t.parent=u.cross)}),o.orders[u.cross]=o.orders[u.cross]||{}},p=function(t){var n=o;t.promos&&e.mix(n.promos,t.promos,!1),t.orders&&(e.isEmptyObject(n.orders)?e.mix(n.orders,t.orders):e.each(t.orders,function(t,r){e.mix(n.orders[r],t,!0,["bundles","averageSum","divisionCode"]);for(var i in n.orders[r].bundles){var s=i.split(";");e.each(s,function(e){n.promos[e]||(console.warn("delete: %s",i),delete n.orders[r].bundles[i])})}t.bundle&&c(r,t.bundle)})),t.relation&&e.mix(n.relation,t.relation),h()},d=function(t){e.isString(t)&&(t=o.promos[t]);if(!e.isObject(t)){console.error("[promo]: Invalid Object");return}if(t.once){var n=t.unused.pop();n?t.used.push(n):console.warn("[promo]: Not Enough Promotion")}else t.used.push(t.unused[0]);return t.used[t.used.length-1]},v=function(t,n){var r=null;e.each(n,function(e){e.indexOf(t)!=-1&&(r=e)}),e.isString(t)&&(t=o.promos[t]);if(!e.isObject(t)){console.error("[promo]: Invalid Object");return}if(t.once){var i;if(r){var s=e.indexOf(t.used,r);t.used.splice(s,1),i=r}else i=t.used.pop();i?t.unused.push(i):console.log("[promo]: Not Use this Promotion")}else t.used.pop();return t.used[t.used.length-1]},m=function(t,n,r,i){if(!t)return;a[t]=a[t]||[],e.each(n.bundles,function(n){e.each(n.promos,function(n){e.inArray(n,r)&&!e.inArray(n,a[t])&&a[t].push(n)})})},g=function(t){var n=o.orders[t];if(t in a){var r=[],i=n.bundle?n.bundle.split(";"):[];e.each(a[t],function(t){e.inArray(t,i)||r.push(t)});var s={};for(var u in n.bundles){var f=u.split(";"),l=!0;e.each(f,function(t){e.inArray(t,r)&&(l=!1)}),l&&(s[u]=n.bundles[u])}return s}return n.bundles},y=function(e,t){var n=o.orders[e];return n?(t&&c(e,t),n.bundle in n.bundles?n.bundles[n.bundle].discount:0):0},b=function(e,t){var n=o.orders[e];if(!n||!t)return;n.amount=t},w={},E=function(){var t=o.orders;e.each(o.orders,function(t,n){e.isEmptyObject(t.bundles)||(w[n]=w[n]||{},w[n].bundles=e.clone(t.bundles),w[n].bundle=t.bundle,t.bundles={},t.bundle=null,c(n,t.bundle))})},S=function(t){return e.isEmptyObject(o.orders)?"":o.orders[t].couple.join(";")},x=function(t){if(e.isEmptyObject(o.orders)||!o.orders[t]||!o.orders[t].bundle)return"";var n=o.orders[t];return n.bundles[n.bundle].desc},T=function(t){if(e.isEmptyObject(o.orders)||!o.orders[t]||!o.orders[t].bundle)return"";var n=o.orders[t];return n.bundles[n.bundle].gift},N=function(){e.each(o.orders,function(e,t){c(t,e.bundle,!0)})},C=e.merge({_init:function(){e.mix(f,this.config.config),e.mix(o,this.config.data),e.mix(u,this.config.meta)},merge:p,resetAll:E,updateOrder:c,updateAmount:b,data:o,blacklist:a,tempOrders:w,config:f,meta:u,base:s,getCouples:S,getDiscount:y,getDesc:x,getGift:T,getBundles:g,cleanUp:h,initPromoBundlesAndCouples:N},e.EventTarget);return C},{requires:["ajax","json","tc/core/rule"]}),KISSY.add("tc/core/laterqueue",function(e){var t={},n=[],r=[],i=0,s=200;return e.mix(t,{add:function(e){n.push(e)},lazyAdd:function(e){r.push(e)},run:function(){if(!n.length){if(!r.length)return;n=[].concat(r),r=[]}var t=n.shift(),o=this;i||(i=+(new Date)),t(),+(new Date)-i<s?o.run():(i=0,e.later(function(){o.run()}))}}),t},{requires:["dom"]}),KISSY.add("tc/mods/winPoints/itemWinPoint-ui",function(e,t,n,r){var i=10;return{_init:function(){var n=e.mix(this,this.config),s=t.attr(n.itemEl,"data-pointRate")||i,o=0;try{o=n.promotion.logic.data.orders[n.itemId].averageSum}catch(u){}n.logic=new r({pointRate:s,averageSum:o,groups:n.groups,itemId:n.itemId})}}},{requires:["dom","event","tc/mods/winPoints/itemWinPoints"]}),KISSY.add("tc/mods/winPoints/itemWinPoints",function(e,t){var n={};return n._init=function(){var n=e.mix(this,this.config);n.rule=t.add("itemWinPoint",function(e,t,r){var i=Math.floor(((parseFloat(r.averageSum)||(e+t)*100)+r.pointBuy)*n.pointRate/1e3);return i},{parents:["quantity","itemPromo"],groups:n.groups,vars:{averageSum:n.averageSum,pointBuy:0}})},n},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/quantity/static-ui",function(e,t,n){var r={};return r._init=function(){var t=e.mix(this,this.config);t.logic=new n({type:"normal",quantity:e.trim(t.quantityEl.value),maxQuantity:99999,groups:t.groups})},r},{requires:["dom","./quantity"]}),KISSY.add("tc/mods/pointBuy/itemPointBuy",function(e,t){return{_init:function(){var n=e.mix(this,this.config);n.rule=t.add("itemPointBuy",function(e){return e.point},{groups:n.groups,vars:{point:0}})},castPoint:function(e){var t=this;t.rule.update({point:e})}}},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/invTitle/ui",function(e,t,n,r,i){var s={};return s._init=function(){e.mix(this,this.config);var s=this.invEl||t.get(".J_Inv"),o={invTitleEl:t.get(".J_EditInvTitle",s),editInvEl:t.get(".J_EditInvInput",s),showInvEl:t.get(".J_EditInvShow",s)};if(!o.editInvEl){console.log("no .J_EditInvInput Dom Element");return}var u={titleName:{value:e.trim(o.editInvEl.value)}},a=new r(u);a.on("invTitle-info",function(e){o.editInvEl.value=e.titleName.value,o.showInvEl&&(o.showInvEl.innerHTML=e.titleName.value)});var f=a.validates;f.invTitleNotNull.on("error",function(e){i.error(o.editInvEl.parentNode,e.msg)}).on("success",function(e){i.clearErr(o.editInvEl.parentNode)}),n.on(o.editInvEl,"blur",function(){a.change({titleName:{value:o.editInvEl.value}})}),n.on(o.invTitleEl,"click",function(e){e.preventDefault(),t.show(t.get(".custom",s)),t.hide(t.get(".default",s))})},s},{requires:["dom","event","./invTitle","tc/core/common"]}),KISSY.add("tc/mods/invTitle/invTitle",function(e,t){var n={validates:{invTitleNotNull:new t}};return n._init=function(){var t=this;e.mix(this,this.config),this.listen("address-change",function(e){e.addressInfo.name&&(t.change({titleName:{value:e.addressInfo.name}}),t._sendMsgToUI())}),this.listen("global-test",function(e){return t.test()})},n.change=function(e){var t=this;t.titleName.value=e.titleName.value,t.test()},n.test=function(){var e=this;return e.validates.invTitleNotNull.validate(e.titleName.value)},n._sendMsgToUI=function(){this.fire("invTitle-info",{titleName:{value:this.titleName.value}})},n},{requires:["tc/form/notNull"]}),KISSY.add("tc/form/notNull",function(e,t){return t.add("notNull",function(t){return!!e.trim(t)},"不能为空")},{requires:["tc/core/form"]}),KISSY.add("tc/mods/memo/cart-ui",function(e,t,n,r,i,s,o){var u={};return u._init=function(){e.mix(this,this.config);var u=this,a=e.get(u.memo||"#J_msgtosaler"),f=e.trim(a.getAttribute("title"));if(!a){console.warn("[memo]: memo %s is not found, ignored.",u.memo);return}var l=u.maxLength||500,c=u.groupId,h=u.requireVerify||!1,p={value:e.trim(a.value),maxLength:l,groupId:c,requireVerify:h},d=new i(p);new o({target:e.get(a)});var v=d.validates;v.memoLength.on("error",function(e){s.error(a.parentNode,"最多输入"+l+"个字符")}).on("success",function(e){s.clearErr(a.parentNode,"最多输入"+l+"个字符")}),h&&v.memoNotNull.on("error",function(e){s.error(a.parentNode,"不能为空")}).on("success",function(e){s.clearErr(a.parentNode,"不能为空")}),n.on(a,"focus",function(){t.removeClass(a,"tips")}),n.on(a,"blur",function(){d.change({memo:{value:e.trim(a.value)}}),e.trim(a.value)||t.addClass(a,"tips")}),e.trim(a.value)&&t.removeClass(a,"tips");var m=d.getStorage(),g=new r(a,{},{resultFormat:"",dataType:2,submitOnSelect:!1});g.on("dataReturn",function(){var t=e.trim(a.value),n=[];for(var r=0,i=m.length;r<i;r++){var s=m[r];s!=null&&s.indexOf(t)!=-1&&n.push(s)}this.returnedData=n})},u},{requires:["dom","event","suggest","./memo","tc/core/common","tc/mods/tools/placeholder/placeholder"]}),KISSY.config({packages:[{name:"gallery",path:"http://a.tbcdn.cn/s/kissy",charset:"utf-8"}]}),KISSY.add("tc/mods/memo/memo",function(e,t,n,r){var i={memo:{readOnly:!1,maxLength:500,value:"",requireVerify:!1}};return i._init=function(){var r=this;e.mix(r.memo,r.config,!0),r.validates={memoNotNull:new t,memoLength:new n({max:r.memo.maxLength})},r.listen("global-test",function(e){var t=r.test();return t&&r.pushToStorage(),t},this.groups),r.memo&&r.memo.value!==""&&r.test()},i.setData=function(t){e.mix(this,t,!0)},i.change=function(t){return e.mix(this,t,!0),this.test()},i.test=function(){return this.requireVerify?this.validates.memoNotNull.validate(this.memo.value)&&this.validates.memoLength.validate(this.memo.value):this.validates.memoLength.validate(this.memo.value)},i.getStorage=function(){var e=r.getItem("msg");return!e||e===""?new Array:e.split(",")},i.pushToStorage=function(){var t=e.trim(this.memo.value),n=this.getStorage();if(e.inArray(t,n))return;t!=null&&t!=""&&(n.length>=5&&n.shift(),n.push(t)),r.setItem("msg",n.join(","))},i},{requires:["tc/form/notNull","tc/form/length","gallery/local-storage/1.0/index"]}),KISSY.add("tc/form/length",function(e,t){var n=t.add("length",function(e,t){return e.length<=(t||100)},"不能超过100"),r=n.prototype.validate;return n.prototype.validate=function(){var e=[].slice.call(arguments);return this.config&&this.config.max&&(e[1]=this.config.max),r.apply(this,e)},n},{requires:["tc/core/form"]}),KISSY.add("tc/mods/tools/placeholder/placeholder",function(e,t,n){var r=e.all,i="placeholder"in document.createElement("input"),s='<div class="placeholder" style="position: relative;display:'+(e.UA.ie>7?"inline-block":"inline")+';zoom:1;"></div>',o='<label style="display: none;position:absolute;left:0;top:0;">{tip}</label>';return{_init:function(){if(i)return;var t=e.mix(this,this.config),n=t.target;n||console.log("[placeholder] has no target to decorate"),n=r(n);var u=n.attr("placeholder");if(!u)return;t.parent||(t.parent=!0),t._decorate=function(){var i=e.substitute(o,{tip:u}),a=t.triggerLabel=r(i);a.css("width",n.css("width")),n.attr("id")?a.attr("for",n.attr("id")):a.on("click",function(){n[0].focus()});var f=r(s);f.appendTo(n.parent()).append(n),a.insertBefore(n),e.later(function(){n.val()||a.show()},100)},n.on("focus",function(e){t.triggerLabel.hide()}),n.on("blur",function(e){n.val()||t.triggerLabel.show()}),t._decorate()},text:function(e){this.triggerLabel.text(e)}}},{requires:["dom","event"]}),KISSY.add("tc/mods/shopPay/cart-ui",function(e,t,n){var r={};return r._init=function(){var r=e.mix(this,this.config);r.logic=new n(r.config),r.logic.on("shopPay-show",function(n){t.html(r.shopPayEl,n.realMoney,"shopPay");var i=e.one(".J_ActualPaidFee",e.one(r.shopPayEl).parent("tbody"));i&&i.val((n.realMoney*100).toFixed(0))})},r},{requires:["tc/core/domcache","./shopPay"]}),KISSY.add("tc/mods/shopPay/shopPay",function(e,t,n){var r={};return r._init=function(){var n=this;e.mix(n.realMoney,n.config,!0),n.rule=t.add("shopPay",function(e,t,n,r,i){return console.log("[update shopPay]: (itemPay)%s, (fare)%s, (shopPromo)%s, (service)%s, (crossShopOrderPromotion)%s",e,t,n,r,i),e*1+t*1+n*1+r*1+i*1},{parents:["itemPay","fare","shopPromo","service","crossShopOrderPromotion"],groups:n.config.groups}),n.rule.on("parentUpdate",function(e){if(e.name!=="itemPay")return;return t.sum(e.parent)}),n.rule.on("selfUpdate",function(e){console.log("[shopPay]: |%s| %s",n.config.orderId,e.result),n.show(e.result)}),n.b2cRule=t.add("b2cShopTotal",function(e,t,r){console.log("[update b2cShopTotal]: %s, %s, %s",e,t,n.config.isB2c);if(n.config.isB2c==="false")return;return e+t+r},{groups:n.config.groups,parents:["itemPay","shopPromo","crossShopOrderPromotion"]}),n.b2cRule.on("parentUpdate",function(e){if(e.name!=="itemPay")return;return t.sum(e.parent)}),n.serviceRule=t.add("service",function(e,t){return(e+t)/100},{parents:["itemService","shopService"],groups:[n.config.orderId]}),n.serviceRule.on("parentUpdate",function(e){if(e.name!=="itemService")return;return t.sum(e.parent)}),n.serviceRule.on("parentUpdate",function(e){if(e.name!=="shopService")return;return t.sum(e.parent)})},r.show=function(t,n){var r=(t||t===0?t:this.realMoney.value).toFixed(2);this.fire("shopPay-show",e.mix({realMoney:r},n))},console.on("log",function(e){this.decorate(e.args,"shopPay","color: red; font-weight: bold;text-align: right; line-height: 30px;")}),r},{requires:["tc/core/rule","tc/core/monitor"]}),KISSY.add("tc/core/monitor",function(e,t,n,r){var i={};return e.mix(i,{init:function(n){var r=this;e.mix(r.config,n);if(!r.config.api){console.warn("[monitor]: please use your custom api.");return}r.timer.cancel(),r.timer=e.later(function(){r.send()},r.config.interval,!0),t.on(window,"unload",function(){r.send(!0)}),r.started=!0},config:{pageId:"",interval:1e3,max:100},started:!1,cache:{},__cache:{},statCache:[],toBeSend:{},timer:e.later(function(){},0),start:function(e){if(!e)return;this.__cache[e]=this.__cache[e]||[],this.cache[e]=this.cache[e]||[],this.__cache[e].push({start:new Date})},end:function(t){if(!(t in this.cache))return;var n=this.__cache[t][this.__cache[t].length-1];e.mix(n,{end:new Date}),this.cache[t].push(n.end-n.start),this.send()},getBaseInfo:function(){this.toBeSend.pageId=this.config.pageId;var t=[n.core,n.shell,n[n.shell]],r="ie";n.core==="trident"&&t.shell!=r&&(t.push(r,n[r]),document.documentMode&&t.push(document.documentMode)),this.toBeSend.ua=t.join(","),this.toBeSend.os=this.getOSInfo(),this.toBeSend.version=e.TC.Version},getOSInfo:function(){var e=[["Windows NT 5.1","WinXP"],["Windows NT 6.0","WinVista"],["Windows NT 6.1","Win7"],["Windows NT 5.2","Win2003"],["Windows NT 5.0","Win2000"],["Macintosh","Macintosh"],["Windows","WinOther"],["Ubuntu","Ubuntu"],["Linux","Linux"]],t=navigator.userAgent;for(var n=0,r=e.length;n<r;++n)if(t.indexOf(e[n][0])!=-1)return e[n][1];return"Other"},__send:function(){if(e.isEmptyObject(this.toBeSend))return;var t=this,n=[],r=t.config.api||"";t.getBaseInfo(),e.each(t.toBeSend,function(e,t){n.push(t+"="+e)}),r+=(r.indexOf("?")===-1?"?":"&")+n.join("&"),t.statCache.push(new Image),t.statCache[t.statCache.length-1].src=r,console.log("[monitor]: sent a monitor request:"),console.log("[monitor]: %s",r)},send:function(t){if(!this.started)return;var n=0,r=0,i=0,s=[],o=this;e.each(o.cache,function(e,t){n++}),e.each(o.cache,function(u,a){r++,i+=o.cache[a].length,s.push(a);if(t&&n===r||i>o.config.max){var f=[];e.each(s,function(e){o.cache[e].length!==0&&(o.toBeSend[e]=o.cache[e].join(",")),o.clear(e)}),o.__send(),o.send(t);return}})},clear:function(e){e?delete this.cache[e]:this.cache={}}}),console.on("log",function(e){this.decorate(e.args,"monitor","color: #0c2d75")}),i},{requires:["event","ua"]}),KISSY.add("tc/mods/fare/ui",function(e,t,n,r,i,s,o){var u=n(['<p class="promo-text-container">','<em title="{{signText}}">{{signText}}</em> ',"</p>"].join("")).render;return{_init:function(){var n=e.mix(this,this.config);n.isServiceForce=!1,n.useCodEl=document.getElementById("J_Form").elements.use_cod,s.html(n.fareSumEl,"0.00","fare"),n.fareLogic=new t(n.config),n.fareLogic.on("update",function(t){var r=n.fareSumEl.parent(".fee");n.isCod?(n.fareSumEl.hide(),e.one(".J_CodTip",r)?e.one(".J_CodTip",r).show():r.append("<span class='J_CodTip cod-tip'>(下一步结算运费)</span>"),e.one(".J_Exclude",n.orderEl).show(),e.one("#J_OrderTable .t").text("商品合计（不含运费）：")):(s.html(n.fareSumEl,t.result.toFixed(2),"fare"),n.fareSumEl.show(),e.one(".J_CodTip",r)&&e.one(".J_CodTip",r).hide(),e.one(".J_Exclude",n.orderEl).hide(),e.one("#J_OrderTable .t").text("实付款："))}),n.listen("recoverFare",function(e){n.recoverSelectedFare(e.fareIndex)})},updateFareBySelectedIndex:function(){var t=this,n=t.fareMenu?t.fareMenu.get("selectedIndex"):t.fareEl.getDOMNode().options.selectedIndex;if(!t.data||!t.data.length)return;if(n<0||n>=t.data.length)n=0;var r=t.data[n],i=t.isCod=r.cod;t.isServiceForce||t.fareLogic.setData({fare:i?0:r.fare,select:!0}),t.useCodEl.value=i?"true":"false",t.showExtra(t.fareEl.parent(),r.signText),e.later(function(){t.broadcast("toggle-cod",{from:"cod",isCod:i},["global"])},100),i&&(e.one(".J_CodPostFee",t.orderEl).val(r.fare),e.one(".J_CodServiceFeeRate",t.orderEl).val(r.buyerRate),e.one(".J_CodSellerFareFee",t.orderEl).val(r.sellerWillingPayCodFee))},renderFromPromo:function(e){var t=this;e&&!t.__data&&t.data&&(t.__data=t._deepClone(t.data));if(e)t._render(null,{isFree:!0});else{var n=t.__data?t._deepClone(t.__data):t.data;t.render(n,{isFree:!1}),t.__data=null}},_render:function(){var t;return function(n,r){var i=this;t&&t.cancel(),e.later(function(){i.render(n,r)},300)}}(),render:function(t,n){var i=this;n&&n.isFree?(t=i.data,e.each(t,function(e){e.fare=0,(e.message||e.extra).indexOf("档")===-1&&(e.message=e.message.replace(/\d+\.\d+元/,"免运费"))})):i.data=t;if(!i.data)return;var s=i.calCodServiceFare();i.fareMenu||i.renderMenuButton();var o=i.fareMenu.get("selectedIndex")||0;try{i.fareMenu.removeItems(!0)}catch(u){console.error(u)}e.each(s,function(e,t){i.fareMenu.addItem(new r.Option({prefixCls:"c2c-",value:e.cod?2:e.id,content:e.codMessage||e.message||e.extra})),e.select&&(o=t)});try{i.fareMenu.set("selectedIndex",o)}catch(u){console.error(u)}t.length===0?(i.fareMenu.hide(),e.one("em.J_FareFree",i.orderEl).show()):(i.fareMenu.show(),e.one("em.J_FareFree",i.orderEl).hide()),i.updateFareBySelectedIndex()},calCodServiceFare:function(){var t=this,n=null;if(!t.data)return;e.each(t.data,function(e,t){if(!e.cod)return;n=n===null?t:n,e.codMessage="货到付款",e.codResult=0});if(n!==null){var r=!1,i=e.clone(t.data),s=i.splice(n,t.data.length-n),o=s[0].codResult;e.each(s,function(e){e.codResult!==o&&(r=!0)});if(!r){var u=s[0];return u.codResult>0?u.codMessage=u.codMessage.replace(/\s\(.+$/,""):u.codMessage="货到付款",s=[u],i.concat(s)}}return t.data},renderMenuButton:function(){var e=this;e.fareMenu=new r.Select.decorate(e.fareEl,{prefixCls:"c2c-"}),e.fareMenu.on("afterSelectedItemChange",function(t){e.updateFareBySelectedIndex();var n=e.fareMenu.get("el").parent().attr("data-point-url");e.broadcast("make-point",{url:n},["global"]),e.broadcast("fare-change",{from:"changefare"},["global"])})},_deepClone:function(t){var n=[];return e.each(t,function(t){n.push(e.clone(t))}),n},showExtra:function(t,n){t=e.one(t);var r=e.one(".promo-text-container",t.getDOMNode());r&&r.remove();if(!n)return;r=o(u({signText:n})).appendTo(t)},recoverSelectedFare:function(t,n){var r=this;if(r.fareMenu){try{e.each(r.fareMenu.get("children"),function(e,i){var s=e.get("value");s==t&&(n^e.get("content")==="货到付款"||(r.fareMenu.set("selectedIndex",i),console.log("[cart-recover]: %s is recover",e.get("content"))))})}catch(i){console.error(i)}r.updateFareBySelectedIndex()}},toggle:function(e){var t=this;e?(t.isServiceForce=!1,t.fareEl.parent(".farearea").show(),t.updateFareBySelectedIndex()):(t.isServiceForce=!0,t.fareEl.parent(".farearea").hide(),t.fareLogic.setData({fare:0}))}}},{requires:["./fare","template","tc/dpl/dropDown","dom","tc/core/domcache","node"]}),KISSY.add("tc/mods/fare/fare",function(e,t,n){var r={_init:function(){var n=e.mix(this,this.config);n.rule=t.add("fare",function(e){return parseInt(e.fare||0,10)/100},{groups:n.groups}),n.rule.on("selfUpdate",function(e){n.fire("update",{result:e.result})})},setData:function(e){this.rule.update(e)}};return r},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/winPoints/winPoint-ui",function(e,t,n,r){return{_init:function(){var t=e.mix(this,this.config);t.logic=new r({groups:t.groups})},updatePoint:function(e){this.logic.rule.update({giftPoint:e})}}},{requires:["dom","event","tc/mods/winPoints/winPoints"]}),KISSY.add("tc/mods/winPoints/winPoints",function(e,t){var n={};return n._init=function(){var n=e.mix(this,this.config);n.rule=t.add("shopWinPoint",function(e,t){return e+ +t.giftPoint},{parents:["itemWinPoint"],groups:n.groups,vars:{giftPoint:0}}),n.rule.on("parentUpdate",function(e){if(e.name!=="itemWinPoint")return;return t.sum(e.parent)})},n},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/pointBuy/shopPointBuy",function(e,t){return{_init:function(){var n=e.mix(this,this.config);n.rule=t.add("shopPointBuy",function(e){return e},{parents:["itemPointBuy"],groups:n.groups}),n.rule.on("parentUpdate",function(e){if(e.name!=="itemPointBuy")return;return t.sum(e.parent)})}}},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/crossShop/ui",function(e,t,n,r){return{_init:function(){e.mix(this,this.config);var t=this,n=e.one("em.J_CrossShopTotal",t.crossShopPayEl);t.crossShop=new r({initCrossShopPromo:t.initCrossShopPromo,crossId:t.crossId,cid:t.cid,oids:t.oids,groups:t.groups}),t.crossShop.rule.on("selfUpdate",function(e){n&&n.html(e.result.toFixed(2))}),t.listen("toggle-cod",function(n){n.from==="cod"&&(n.isCod?e.all("span.J_Exclude",t.crossShopPayEl).show():e.all("span.J_Exclude",t.crossShopPayEl).hide())},["global"])}}},{requires:["dom","event","./crossShop"]}),KISSY.add("tc/mods/crossShop/crossShop",function(e,t){return{_init:function(){e.mix(this,this.config);var n=this;n.crossShopOrderRules={},e.each(n.oids,function(e){n.crossShopOrderRules[e]=t.add("crossShopOrderPromotion",function(e){return-e.promo/100},{vars:{promo:0},groups:[e]}),n.crossShopOrderRules[e].update({promo:n.initCrossShopPromo[e]*1})}),n.rule=t.add("crossShop",function(e){return e},{parents:["shopPay"],groups:n.oids}),n.rule.on("parentUpdate",function(e){if(e.name!="shopPay")return;return t.sum(e.parent)})}}},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/realPay/ui",function(e,t,n){var r={};return r._init=function(){e.mix(this,this.config);var r=e.one(this.actualFee||"#J_ActualFee"),i=e.one(this.totalSum||"#J_TotalSum"),s=new t(this.config);s.on("realPay-show",function(e){n.html(r,e.realMoney),i&&i.val(e.realMoney)},null,this.groups)},r},{requires:["./realPay","tc/core/domcache"]}),KISSY.add("tc/mods/realPay/realPay",function(e,t){var n={realMoney:{readOnly:!1,value:""}};return n._init=function(){var n=this;e.mix(n.realMoney,n.config,!0),n.rule=t.add("realPay",function(e,t,n){var r=0;return n>0?r=n+t:r=e+t,r<0&&(console.log("[realpay]: result is less than zero. use 0"),r=0),r},{parents:["shopPay","point","stepShopPay"],groups:n.groups}),n.rule.on("parentUpdate",function(e){if(e.name!=="shopPay")return;return t.sum(e.parent)}),n.rule.on("parentUpdate",function(e){if(e.name!=="crossShopPromo")return;return t.sum(e.parent)}),n.rule.on("selfUpdate",function(e){console.log("[realPay]: |%s| %s",n.config.cartId,e.result),n.realMoney.fullPointPay?n.show(0):n.show(e.result),n.broadcast("realpay-change",{from:"realpay",realpay:n.realMoney.fullPointPay?0:e.result},["global"])})},n.show=function(t,n){var r=(t||t===0?t:this.realMoney.value).toFixed(2);this.fire("realPay-show",e.mix({realMoney:r},n),null,this.groupId)},n.setMoney=function(e,t){if(this.realMoney.readOnly){console.log("[realpay]: realMoney is readOnly");return}this.realMoney.value=e,t&&this.show(this.realMoney.value)},n},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/submit/cart-ui",function(e,t,n,r){var i={};return i._init=function(){var i=e.mix(this,this.config),s=new r,o=e.get(this.submitForm||"#J_Form"),u=e.get(this.submitId||"#J_Go");i.formAction=e.one(o).attr("action").value,i.buyAction=e.get(o).elements.action.value,u&&(u.disabled=!1),s.on("submit",function(){if(u){u.disabled=!0;if(i.isTips&&i.isTips.value){var n=e.get(".submit-tips");n||(n=document.createElement("div"),t.addClass(n,"submit-tips"),u.parentNode.appendChild(n),t.show(n),n.innerHTML="正在处理，请稍候...")}var r=e.one(u).attr("data-point-url");i.broadcast("make-point",{url:r},["global"])}var s=e.get(o).elements.use_cod;s&&s.value=="true"&&e.one("#J_CodAction")&&(e.one(o).attr("action",e.one("#J_CodAction").val()),e.get(o).elements.action.value=e.one("#J_CodActionNew").val(),t.remove(e.get(o).elements.event_submit_do_confirm)),o.submit()}),n.on(u,"click keypress",function(e){e.preventDefault(),e.type==="keypress"?e.keyCode==13&&s.submit():s.submit()}),n.on(o,"submit",function(e){e.preventDefault(),s.submit()}),i.listen("toggle-cod",function(t){t.isCod?e.one(u).addClass("btn-codgo"):e.one(u).removeClass("btn-codgo")},["global"])},i},{requires:["dom","event","./submit"]}),KISSY.add("tc/mods/submit/submit",function(e,t,n){return{_init:function(){var e=this;t.get("#J_verifyImage")&&e.listen("checkCode:success",function(){e.test()})},submit:function(){var e=this;t.get("#J_verifyImage")||e.test(),e.broadcast("checkCode")},test:function(){var e=this;e.broadcast("global-test")!==!1&&e.fire("submit")}}},{requires:["dom","tc/core/monitor"]}),KISSY.add("tc/mods/addressNew/cartAddress-ui",function(e,t,n,r,i,s){return{_init:function(){e.mix(this,this.config);var o=this,u=e.UA["ie"]==6,a=t.get(o.address||"#address"),f=t.query("li.J_Addr",a),l=t.get(o.otherAddressLinkEl||"#J_OtherAddressLink"),c=e.get(o.newAddress||"#J_NewAddress"),h=e.get(o.otherAddress||"#J_NewAddressBtn"),p=o.addressShower=new n(this.config),d=o.handler=new r(this.config),v=new i,m=new s({target:c,offset:t.offset(h)});p.addTarget(o),d.addTarget(o),p.publish("switch",{bubbles:1}),p.publish("showPopup",{bubbles:1}),p.publish("hidePopup",{bubbles:1}),d.publish("add",{bubbles:1}),d.publish("edit",{bubbles:1}),p.publish("confirm",{bubbles:1}),p.publish("updateLogic",{bubbles:1}),p.publish("add",{bubbles:1}),p.publish("edit",{bubbles:1});var g=function(t){var n=[];return e.query(".J_Shop",t).each(function(t){var r=[],i=t.getAttribute("data-outorderid");e.query(".item",t).each(function(e){r.push(e.getAttribute("data-lineid"))}),n.push(i+"_"+r.join(","))}),n.join("|")},y=function(t){e.all('<form method="post" id="J_Refresh" action="/auction/order/confirm_order.htm"></form>').appendTo(e.one("body"));var n='<input type="hidden" name="{key}" value="{value}" />',r=[];for(var i in t)r.push(e.substitute(n,{key:i,value:t[i]}));e.one("#J_Refresh").append(r.join("")),e.get("#J_Refresh").submit()},b=function(){var t=e.get("#paramString").value,n={},r=e.get("#J_OrderInfoString")?e.get("#J_OrderInfoString").value:"",i=t.split("&");e.each(i,function(e){var t=e.split("=");n[t[0]]=t[1]});var s=e.get("#unable-buy table"),o=e.get("#J_OrderTable");n.valid=g(o),n.invalid=g(s),n.orderInfoString=r,y(n)};o.on("add",function(e){p.getSelectAddr()||b();var t=e.addressInfo;d.updateLogic(t),p.update({addressInfo:t,isDefault:e.isDefaultAddress}),o.fire("confirm",{addressInfo:t})}),o.on("edit",function(e){var t=e.addressInfo;d.updateLogic(t),p.update({addressInfo:t,isDefault:e.isDefaultAddress}),o.fire("confirm",{addressInfo:t})}),o.on("confirm",function(t){e.one("#J_AddrConfirm")&&(e.one("#J_AddrConfirm").html(v.getAddrConfirmString(t.addressInfo)),e.one("#J_AddrNameConfirm").html(v.getNameConfirmString(t.addressInfo)))}),o.on("switch",function(e){d.updateLogic(e.addressLine.getAddressInfo())}),o.on("hidePopup",function(e){m.hide()}),o.on("showPopup",function(e){e.addressLine?d.reset(e.addressLine.getAddressInfo()):d.reset(),m.show(e.offset)}),o.on("updateLogic",function(e){d.updateLogic(e.addressInfo)}),f.length||(t.hide(l),e.all(".J_AddAddr",c).show(),e.all(".J_EditAddr",c).hide(),m.show(t.offset(c)));var w=p.getSelectAddr();if(w){w.checked(!0),o.hasSelectAddress||d.initLogic(w.getAddressInfo()),o.fire("confirm",{addressInfo:w.addressInfo});if(!w.temp()){e.one(".J_Marker",w.addressEl).css("top","-50px");var E=e.one(".J_Marker",w.addressEl);(new e.Anim(E,{top:u?"1px":"6px"},1,"bounceOut")).run()}}},getAddressInfo:function(){return this.handler.getAddressInfo()}}},{requires:["dom","./showAddress-ui","./addressHandler-ui","./util/tplFactory","./util/addressPopup"]}),KISSY.add("tc/mods/addressNew/showAddress-ui",function(e,t,n,r,i,s){var o={};return o._init=function(){e.mix(this,this.config);var s=this,o=t.get(this.address||"#address"),u=t.query("li.J_Addr",o),a=t.get(this.defaultAddrBox||"#address-list"),f=t.get(this.moreAddress||"#J_MoreAddress"),l=t.get(this.otherAddressLinkEl||"#J_OtherAddressLink"),c=t.get(this.otherAddress||"#J_NewAddressBtn"),h=t.get(this.newAddress||"#J_NewAddress"),p=t.get(this.cancel||"#J_Cancel"),d=t.get(this.daiShouHuoLinkEl||"#J_daiShouHuoLink"),v=t.get(this.stationFrameEL||"#J_stationFrame"),m=new i,g=s.addrs={},y,b,w,x,T=!1,N;document.domain=function(){var e=location.hostname.indexOf("daily")>-1?3:2,t=location.hostname.split(".");return t.splice(t.length-e>0?t.length-e:0,e).join(".")}(),e.each(u,function(t,n){var i=e.one("input",t),o=e.trim(i.attr("ah:params")),u=new r({addressEl:t,addressInputEl:i,selected:i.checked,defaultAddress:e.one(t).hasClass("J_DefaultAddr"),tempAddress:i.val()==0,addressInfo:{addrDetailString:o,daiShouHuo:e.one(".J_UseDai",t)?!0:!1}});g[i.val()]=u,s.defaultAddressSelected?n||(s.selectedAddr=u):i.attr("checked")&&(s.selectedAddr=u),u.defaulted()&&(y=u,y.defaulted(!0)),u.temp()&&(b=u)}),b&&(n.on("#J_LinkEdit","click",function(n){n.preventDefault(),t.hide("#temp-address"),s.fire("showPopup",{offset:t.offset(h)}),e.one("#J_EmNotice").show(),b.getAddressInfo().daiShouHuo===!0&&s._editDaiShouHuo()}),n.on("#temp-address .cancel","click",function(e){e.preventDefault(),s._closeTempHandle()}),s.selectedAddr=b),s.selectedAddr&&(x=w=s.selectedAddr);var C=function(){t.hide(l),t.show(c),t.show(f),T=!0,t.addClass(d,"lower"),t.show(d)},k=e.all(".J_DaiAddr",h),L=e.all(".J_CommonAddr",h),A=e.all(".J_AddAddr",h),O=e.all(".J_EditAddr",h),M=function(){k.show(),L.hide(),A.hide(),O.hide()},_=function(){k.hide(),L.show(),A.show(),O.show()};s.defaultAddressSelected||C(),s.selectedAddr&&!e.get("li.J_Addr",f)&&C(),s.selectedAddr&&s.selectedAddr.temp()&&(x=y,C(),t.hide(c),t.hide(d)),t.hide("a.J_DefaultHandle",o),u.length>0&&e.one("#J_fastbuyNotice")&&e.one("#J_fastbuyNotice").remove(),function(){n.on(l,"click",function(e){e.preventDefault(),t.removeClass(f,"hidden"),C()}),n.on([a,f],"mouseover mouseout",function(n){var r=n.target;if(n.target.tagName==="UL")return;t.hasClass(r,".J_Addr")||(r=t.parent(r,".J_Addr"));var i=g[e.one("input",r).val()];if(!i||i.temp())return;if(e.one(".J_DefaultHandle",r).hasClass("address-loading"))return;n.type==="mouseover"?i.hover():i.unhover()}),n.on(o,"click",function(n){var r=n.target,i=r;t.hasClass(r,"J_Addr")||(i=t.parent(r,"li.J_Addr"));if(!i)return;var o=g[e.one("input",i).val()];if(t.hasClass(r,".J_DefaultHandle")){n.preventDefault();var u=e.one(".address-loading");u&&(u.removeClass("address-loading"),u.hide()),y&&y.defaulted(!1),o.defaulted(!0),y=o}else if(t.hasClass(r,"J_Addr")||r.tagName==="INPUT"&&r.type==="radio"){if(o===w)return;if(!confirm("更换地址后，您需要重新确认订单信息")){n.preventDefault(),w.checked(!0);return}if(w.temp()){if(!confirm("更换地址后，您的临时地址将会丢失")){n.preventDefault(),w.checked(!0);return}t.remove("#temp-address"),t.show(c),t.show(d),t.addClass(d,"lower")}s.fire("hidePopup"),t.hasClass(f,"hidden")||t.show(c),w.checked(!1),w=o,w.checked(!0),x=w,s.fire("switch",{addressLine:w}),s.fire("confirm",{addressInfo:w.addressInfo})}else t.hasClass(r,"J_Modify")&&(w.addressInfo.daiShouHuo?(s._editDaiShouHuo(),e.one("#J_EmNotice").hide()):(_(),e.one("#J_EmNotice").hide(),e.all(".J_AddAddr").hide(),e.all(".J_EditAddr").show(),o.defaulted()?e.one("#setDefaultAddress").parent("li").hide():e.one("#setDefaultAddress").parent("li").show()),s.fire("showPopup",{addressLine:o,offset:{top:t.offset(o.addressEl).top+t.height(o.addressEl)}}))}),n.on("#content a.J_ChangeAddressHook","click",function(e){e.preventDefault(),t.scrollIntoView(o,window)}),s._editDaiShouHuo=function(){var e=w.addressInfo,t=e.stationId,n=e.lgBuyAddId,r=e.area.value;v.src=s.deliveryAPI+"?lgBuyAddId="+n+"&stationId="+t+"&areaId="+r,M(),N="edit"}}(),e.later(function(){s._closeTempHandle=function(){confirm("选择“关闭”将清空您的修改并返回上次选择状态，是否继续？")&&(u.length<=20&&T&&(t.show(c),t.show(d)),t.remove("#temp-address"),s.fire("hidePopup"),w!=x&&(w.checked(!1),w=x,w.checked(!0),s.fire("updateLogic",{addressInfo:w.addressInfo}),s.fire("confirm",{addressInfo:w.addressInfo})))},n.on(c,"click",function(n){n.preventDefault(),_(),u.length>=20?(e.one("#J_EmNotice").css("left","103px").show(),e.one("#setDefaultAddress").parent("li").hide()):(e.one("#J_EmNotice").hide(),e.one("#setDefaultAddress").parent("li").show()),e.one("#setDefaultAddress").removeAttr("checked"),e.all(".J_EditAddr",h).hide(),s.fire("showPopup",{addressLine:w,offset:{top:t.offset(c).top}})}),n.on("#J_LinkCancel","click",function(t){t.preventDefault(),u.length?s._closeTempHandle():e.one("#J_fastbuyNotice")?alert("为了保证您顺利完成购物，请完善您的收货地址信息。"):history.go(-1)}),n.on(p,"click",function(e){e.preventDefault(),s._closeTempHandle()}),n.on(d,"click",function(n){n.preventDefault();var r=w.addressInfo,i=r.area.value,o=r.addressId,a=r.daiShouHuo;u.length>=20?e.one("#J_EmNotice").css("left","130px").show():e.one("#J_EmNotice").hide(),v.src=s.deliveryAPI+"?areaId="+i+"&id="+o+"&isStation="+a,M(),s.fire("showPopup",{addressLine:w,offset:{top:t.offset(c).top}}),N="add"}),s.setStation=function(e){if(e.success===!0){var n=e.id,r=e.id;if(u.length>=20&&N==="add"||t.get("#temp-address"))n=0;var i="";for(var o in e)i+=o+"="+e[o]+"^^";var a={addressId:n,prov:{value:"",name:""},city:{value:"",name:""},area:{value:e.areaCode,name:""},postCode:e.postCode,street:e.address,name:e.addressee,mobile:e.mobile,phone:{phoneSection:"",phoneCode:"",phoneExt:""},daiShouHuo:!0,lgBuyAddId:r,stationId:e.stationId,addrDetailString:i};e.phone&&(a.phone.phoneSection=e.phone.split("-")[0]||"",a.phone.phoneCode=e.phone.split("-")[1]||"",a.phone.phoneExt=e.phone.split("-")[2]||""),s.fire(N,{addressInfo:a,isDefault:!1})}else e.success===!1&&s.fire("hidePopup")},s.setStationFrameHeight=function(e,n){t.css(v,"height",n),t.css(v,"width",e)}},10),s.on("addLine",function(i){var o,a=i.addressInfo;u.length>=20&&(a.addressId=0),a.addressId<=0?(o=t.get("#temp-address"),o&&t.remove(o),o=t.create(m.createTpl(a)),f.appendChild(o),n.on("#J_LinkEdit","click",function(n){n.preventDefault(),s.fire("showPopup",{offset:t.offset("#temp-address")}),t.hide("#temp-address"),e.one("#J_EmNotice").show(),a.daiShouHuo===!0&&s._editDaiShouHuo()}),n.on("#temp-address .cancel","click",function(e){e.preventDefault(),s._closeTempHandle()}),t.hide(c),t.hide(d),t.hide(l),T=!0,t.addClass(d,"lower")):(o=t.create(m.createTpl(a)),u.length==1&&t.show(f),u.push(o),C(),f.appendChild(o),x=w);var h=e.get("input",o),p=new r({addressEl:o,addressInputEl:h,selected:h.checked,addressInfo:a,tempAddress:a.addressId==0,defaultAddress:i.isDefault});g[a.addressId]=p,w.checked(!1),w=p,w.checked(!0),t.show(f),t.show(o),s.fire("hidePopup"),i.isDefault&&(y&&y.defaulted(!1),w.defaulted(!0),y=w)}),s.on("updateLine",function(t){var n=s.addrs[t.addressInfo.addressId];e.mix(n.addressInfo,t.addressInfo,!0),e.one("label",n.addressEl).html(m.getUpdateAddressInfoTpl(t.addressInfo)),n.addressInputEl.attr("ah:params",t.addressInfo.addrDetailString),s.fire("hidePopup"),t.isDefault&&(y&&y.defaulted(!1),w.defaulted(!0),y=w)})},e.mix(o,{update:function(e){var t=this;t.addrs[e.addressInfo.addressId]&&!t.addrs[e.addressInfo.addressId].temp()?t.fire("updateLine",{addressInfo:e.addressInfo,isDefault:e.isDefault}):t.fire("addLine",{addressInfo:e.addressInfo,isDefault:e.isDefault})},getSelectAddr:function(){return this.selectedAddr}}),o},{requires:["dom","event","./addressLine","./util/tplFactory"]}),KISSY.add("tc/mods/addressNew/addressLine",function(e,t,n,r,i){function s(t){var n=[],r={};return e.each(t.split("^^"),function(e){n=e.split("="),r[n[0]]=n[1]}),r}var o=function(n,r,i){var s=t.get("div.J_Msg",n);s||(s=document.createElement("DIV"),s.className="msg J_Msg",n.appendChild(s)),s.innerHTML=i,t.show(s),r&&(t.removeClass(t.get(".J_DefaultAddr"),"J_DefaultAddr"),t.addClass(n,"J_DefaultAddr")),e.later(function(){t.hide(s)},2500,!1)},u={LOADING:"正在设置...",SUCCESS:"设置成功！",ERROR:"对不起，设置失败，请稍后重试！"};return{_init:function(){var t=this,n={addressEl:null,addressInputEl:null,defaultAddress:!1,tempAddress:!1,selected:!1,addressInfo:{addressId:0,prov:{value:"",name:""},city:{value:"",name:""},area:{value:"",name:""},postCode:"",street:"",name:"",mobile:"",phone:{phoneSection:"",phoneCode:"",phoneExt:""},addrDetailString:"",daiShouHuo:!1,lgBuyAddId:"",stationId:""}};e.mix(n,this.config,undefined,undefined,!0),e.mix(t,n),t.addressInfo.addrDetailString&&t._parse(t.addressInfo.addrDetailString),t.addressEl&&(t.addressEl=e.one(t.addressEl),t.addressInputEl=e.one(t.addressInputEl),t.defaultHandleEl=e.one("a.J_DefaultHandle",t.addressEl)),t.on("hover",function(e){!t.defaultAddress&&!t.addressInfo.daiShouHuo&&t.defaultHandleEl.show()}),t.on("unhover",function(e){!t.defaultAddress&&!t.addressInfo.daiShouHuo&&t.defaultHandleEl.hide()})},checked:function(e){var t=this;if(!(e+1))return t.selected;if(t.temp())return;t.selected=e,t.addressEl[e?"addClass":"removeClass"]("selected"),t.addressInputEl.attr("checked",e)},defaulted:function(t){var n=this;if(!(t+1))return n.defaultAddress;t?(n.defaultAddress||(n.defaultHandleEl.addClass("address-loading"),r.post(n.defaultHandleEl.attr("href"),function(t){t=i.parse(t),t.status=="success"?(o(n.addressEl.getDOMNode(),!0,'<p class="ok naked">'+u.SUCCESS+"</p>"),e.get("#defaultId")&&(e.get("#defaultId").value=t.data.addrid)):o(n.addressEl.getDOMNode(),!1,'<p class="error naked">'+u.ERROR+"</p>")})),e.one(".tip",n.addressEl).show()):(n.addressEl.removeClass(".J_DefaultAddr"),e.one(".tip",n.addressEl).hide()),n.defaultAddress=t},temp:function(e){if(!(e+1))return this.tempAddress;this.tempAddress=e},_parse:function(e){var t=this,n=s(e);t.addressInfo.addressId=n.id,t.addressInfo.street=n.address,t.addressInfo.postCode=n.postCode,t.addressInfo.name=n.addressee,n.phone&&(t.addressInfo.phone.phoneSection=n.phone.split("-")[0]||"",t.addressInfo.phone.phoneCode=n.phone.split("-")[1]||"",t.addressInfo.phone.phoneExt=n.phone.split("-")[2]||""),t.addressInfo.mobile=n.mobile,t.addressInfo.area.value=n.areaCode,t.addressInfo.stationId=n.stationId,t.addressInfo.lgBuyAddId=n.id},hover:function(){this.fire("hover")},unhover:function(){this.fire("unhover")},getAddressInfo:function(){return this.addressInfo},setEl:function(t){var n=this;n.addressEl=e.one(t),n.addressInputEl=e.one("input",n.addressEl),n.defaultHandleEl=e.one("a.J_DefaultHandle",n.addressEl)}}},{requires:["dom","event","ajax","json"]}),KISSY.add("tc/mods/addressNew/util/tplFactory",function(e,t){var n=t(["<li class='J_Addr J_MakePoint selected clearfix'","data-point-url='http://www.atpanel.com/buy.1.20'>",'<s class="J_Marker marker"></s>','<span class="marker-tip">寄送至</span>','<a href="#" class="J_Modify modify J_MakePoint" data-point-url="http://www.atpanel.com/buy.1.21">修改本地址</a>',"<input name='address' type='radio' value='{{address.addressId}}' id='addrId_{{address.addressId}}' ","data-point-url='http://www.atpanel.com/buy.1.20' ","ah:params='{{address.addrDetailString}}' class='J_MakePoint' checked='checked' />","<label for='addrId_{{address.addressId}}'>","{{daiRender}}","{{address.prov.name}} {{address.city.name}} ","{{address.area.name}} {{address.street}} ({{address.name}} 收) <em>{{address.mobile}}</em></label>","<em class='tip' style='display: none'>默认地址</em>","<a class='J_DefaultHandle set-default' style='display:none'","href='http://"+location.host+"/auction/update_address_selected_status.htm?addrid={{address.addressId}}'>","设置为默认收货地址</a></li>"].join("")).render,r=t(["<li id='temp-address' class='J_Addr J_MakePoint selected clearfix'","data-point-url='http://www.atpanel.com/buy.1.20'>","<input name='address' type='radio' value='{{address.addressId}}' id='addrId_{{address.addressId}}' ","data-point-url='http://www.atpanel.com/buy.1.20' ","ah:params='{{address.addrDetailString}}' class='J_MakePoint' checked='checked' />","<label for='addrId_{{address.addressId}}'>","{{daiRender}}","{{address.prov.name}} {{address.city.name}} ","{{address.area.name}} {{address.street}} ({{address.name}} 收) <em>{{address.mobile}}</em></label>","<a href='#' class='edit' id='J_LinkEdit'>编辑</a>",'<a href="#" class="cancel" title="关闭"><span>关闭</span></a>','<div class="msg" style="margin: 3px 0 3px 22px">','<p class="attention">地址库已满，新地址无法入库，但本次可用。','<a title="管理我的收货地址" target="_blank" href="http://member1.taobao.com/member/fresh/deliver_address.htm">管理我的收货地址</a></p>',"</div></li>"].join("")).render,i=t(["{{address.prov.name}} {{address.city.name}} ","{{address.area.name}} {{address.street}}"].join("")).render,s=t(["{{address.name}} {{address.mobile}}"].join("")).render,o=t(["{{address.prov.name}} {{address.city.name}} ","{{address.area.name}} {{address.street}} ({{address.name}} 收) <em>{{address.mobile}}</em>"].join("")).render;return{createTpl:function(e){var t="";return e.daiShouHuo&&(t='<span class="J_UseDai">[服务站] </span>'),e.addressId<=0?r({address:e,daiRender:t}):n({address:e,daiRender:t})},getAddrConfirmString:function(e){return i({address:e})},getNameConfirmString:function(e){return s({address:e})},getUpdateAddressInfoTpl:function(e){return e.daiShouHuo?'<span class="J_UseDai">[服务站] </span>'+o({address:e}):o({address:e})}}},{requires:["template"]}),KISSY.add("tc/mods/addressNew/addressHandler-ui",function(e,t,n,r,i,s,o,u,a,f,l,c){function p(e){var t=s.get("#J_Form").elements;t.n_area.value=e.area.value,t.n_city.value=e.city.value,t.n_prov.value=e.prov.value,t.postCode.value=e.postCode,t.deliverAddr.value=e.street,t.addressId.value=e.addressId,t.deliverMobile.value=e.mobile,t.deliverName.value=e.name,t.deliverPhone.value=[e.phone.phoneSection,e.phone.phoneCode,e.phone.phoneExt].join("-"),t.divisionCode.value=e.area.value?e.area.value:e.city.value,e.daiShouHuo?(t.useSelfCarry.value=!0,t.selfCarryStationId.value=e.stationId):(t.useSelfCarry.value=!1,t.selfCarryStationId.value=0)}var h={};return h._init=function(){e.mix(this,this.config);var c=this;this.selector=new r;var h=s.get(this.prov||"#n_prov_select"),p=s.get(this.city||"#n_city_select"),d=s.get(this.area||"#n_area_select"),v=c.postCodeEl=s.get(this.postCode||"#J_postCode"),m=s.get(this.street||"#deliverAddress"),g=s.get(this.name||"#deliverName"),y=s.get(this.mobile||"#deliverPhoneBak"),b=s.get(this.phoneSection||"#phoneSection"),w=s.get(this.phoneCode||"#phoneCode"),x=s.get(this.phoneExt||"#phoneExt"),T=s.get(this.addSureEl||"#J_AddSure"),N=s.get(this.editSureEl||"#J_EditSure"),k=s.get(this.divisionCode||"#divisionCode"),L=s.get(this.setDefaultAddressEl||"#setDefaultAddress"),A="add",O="edit";i.InputHint.decorate("#"+m.id,{hintClass:"tips"}),this.postSelector=new l({postCodeAPI:c.postCodeAPI,postCodeEl:v}),c._fill=function(e){v.value=e.postCode||"",m.value=e.street||"",g.value=e.name||"",y.value=e.mobile||"",e.phone&&(b.value=e.phone.phoneSection||"",w.value=e.phone.phoneCode||"",x.value=e.phone.phoneExt||""),s.removeClass("#deliverAddress","tips"),k.value=e.area.value||"",c.selector.updateAll(e.area.value)};var M=c.addressLogic=new n,_=M.validates,P={proveNotNull:h,cityNotNull:p,areaNotNull:d};for(var H in P)(function(e){_[e].on("error",function(n){t.error(P[e].parentNode,"省、市、区不能为空")}).on("success",function(n){t.clearErr(P[e].parentNode,"省、市、区不能为空")})})(H);var B={streetNotNull:m,mobileNotNull:y,normalPostCode:v,specPostCode:v,street:m,name:g,phone:b,mobile:y};for(var j in B)(function(n){_[n].on("error",function(r){n=="phone"?e.later(function(){t.error(B[n].parentNode,r.msg)},200,!1):t.error(B[n].parentNode,r.msg)}).on("success",function(r){e.later(function(){t.clearErr(B[n].parentNode,r.msg)},200,!1)})})(j);M.on("cleanMobile",function(e){t.clearErr(y.parentNode,undefined)}),M.on("error",function(e){t.error(x.parentNode,e.msg)}),M.on("success",function(e){t.clearErr(x.parentNode,e.msg)}),function(){e.each({provMenu:h,cityMenu:p,areaMenu:d},function(e,t){c[t]=a.Select.decorate(e,{prefixCls:"c2c-",menuCfg:{elStyle:{overflow:"auto",overflowX:"hidden",height:150,margin:"0 4px"}}}),c.selector[t]=c[t]});var t=function(t){var n=e.trim(c.provMenu.get("value")),r=e.trim(c.provMenu.get("content"));t&&t==="prov"&&c.selector.updateCity(n),v.value="",t&&t!=="area"&&c.selector.updateArea(c.cityMenu.get("value")),M.change({addressInfo:{prov:{value:n,name:r},city:{value:e.trim(c.cityMenu.get("value")),name:e.trim(c.cityMenu.get("content"))},area:{value:e.trim(c.areaMenu.get("value")),name:e.trim(c.areaMenu.get("content"))}},isNew:!0}),c.postSelector.getPostCode(M.addressInfo.area.value?M.addressInfo.area.value:M.addressInfo.city.value,function(){M.addressInfo.postCode=e.trim(v.value),c.addressLogic.testPostCode()})};c.provMenu.on("afterSelectedItemChange",function(e){t("prov")}),c.cityMenu.on("afterSelectedItemChange",function(e){t("city")}),c.areaMenu.on("afterSelectedItemChange",function(e){t("area")})}(),function(){o.on(v,"blur",function(){M.change({addressInfo:{postCode:e.trim(v.value)},isNew:!0})}),o.on(m,"blur",function(){M.change({addressInfo:{street:e.trim(m.value)},isNew:!0})}),o.on(g,"blur",function(){M.change({addressInfo:{name:e.trim(g.value)},isNew:!0})}),o.on([y,b,w,x],"blur",function(){M.change({addressInfo:{mobile:e.trim(y.value),phone:{phoneSection:e.trim(b.value),phoneCode:e.trim(w.value),phoneExt:e.trim(x.value)}},isNew:!0})}),c.on("remoteUpdate",function(t){M.change({addressInfo:{prov:{value:e.trim(c.provMenu.get("value")),name:e.trim(c.provMenu.get("content"))},city:{value:e.trim(c.cityMenu.get("value")),name:e.trim(c.cityMenu.get("content"))},area:{value:e.trim(c.areaMenu.get("value")),name:e.trim(c.areaMenu.get("content"))},postCode:e.trim(v.value),street:e.trim(m.value),name:e.trim(g.value),mobile:e.trim(y.value),phone:{phoneSection:e.trim(b.value),phoneCode:e.trim(w.value),phoneExt:e.trim(x.value)}}});if(!M.test())return;var n=M.addressInfo,r=L&&L.checked;u.post(t.remoteAPI,{deliverAddress:n.street,deliverName:n.name,deliverPhone:M.getPhoneString(),deliverPhoneBak:n.mobile,divisionCode:n.area.value||n.city.value,postCode:n.postCode,isDefaultDeliverAddress:r,addrId:n.addressId},function(n){n=e.isPlainObject(n)?n:f.parse(n),n.is_success===1&&(M.change({addressInfo:{addressId:n.address_id,addrDetailString:e.trim(n.params),daiShouHuo:!1}}),c.fire(t.handleType,{addressInfo:M.addressInfo,isDefaultAddress:r}))})}),o.on(T,"click",function(e){e.preventDefault(),c.fire("remoteUpdate",{remoteAPI:c.addAddressAPI,handleType:A})}),o.on(N,"click",function(e){e.preventDefault(),c.fire("remoteUpdate",{remoteAPI:c.updateAddressAPI,handleType:O})})}()},e.mix(h,{initLogic:function(t){var n=this,r=n.getBaseAddressFromArea(t.area.value);e.mix(t,r),n.addressLogic.change({addressInfo:t}),n.broadcast("initAddress",{addressInfo:n.addressLogic.addressInfo,isInit:!0})},updateLogic:function(t){var n=this,r=n.getBaseAddressFromArea(t.area.value);e.mix(t,r),n.addressLogic.change({addressInfo:t}),n.addressLogic.updateDivision(),p(n.addressLogic.addressInfo)},reset:function(t){var n=this;e.all("#J_NewAddress .label-error").hide(),t&&n.addressLogic.change({addressInfo:t});var r=n.addressLogic;n.areaMenu.removeItems(!0);var i=n.getBaseAddressFromArea(r.addressInfo.area.value);e.mix(r.addressInfo,i),n._fill(r.addressInfo)},getBaseAddressFromArea:function(e){var t=this.selector.getAddress(e,[]),n={};return t.length&&(t[0]&&(n.prov={name:t[0].name,value:t[0].id}),t[1]&&(n.city={name:t[1].name,value:t[1].id}),t[2]&&(n.area={name:t[2].name,value:t[2].id})),n},getAddressInfo:function(){return this.addressLogic.addressInfo}}),h},{requires:["tc/core/common","./address","./util/districtSelector","tc/core/widget","dom","event","ajax","tc/dpl/dropDown","json","./util/postCodeSelector","ua"]}),KISSY.add("tc/mods/addressNew/address",function(e,t,n,r,i,s,o,u,a,f,l,c){var h={addressInfo:{addressId:0,prov:{value:"",name:""},city:{value:"",name:""},area:{value:"",name:""},postCode:"",street:"",name:"",mobile:"",phone:{phoneSection:"",phoneCode:"",phoneExt:""}},validates:{proveNotNull:new n,cityNotNull:new n,areaNotNull:new n,streetNotNull:new n,mobileNotNull:new n,normalPostCode:new i,specPostCode:new r,street:new s,name:new o,phone:new u,mobile:new a}};return h._init=function(){e.mix(this,this.config);var t=this},h.updateDivision=function(){var t=this,n=["810100","810200","810300"],r=e.indexOf(t.addressInfo.city.value,n)!==-1&&t.addressInfo.area.value==="";t.area=r?t.addressInfo.city.value:t.addressInfo.area.value,t.broadcast("address-change",{addressInfo:t.addressInfo})},h.getPhoneString=function(){var e="";return this.addressInfo.phone.phoneSection?(e=[this.addressInfo.phone.phoneSection,this.addressInfo.phone.phoneCode].join("-"),e+=this.addressInfo.phone.phoneExt?"-"+this.addressInfo.phone.phoneExt:"",e):e},h.change=function(t){e.mix(this.addressInfo,t.addressInfo,!0),this.addressInfo.area.value||(this.addressInfo.area=this.addressInfo.city),t.isNew&&this.test(t)},h.testPosition=function(){var e=this.validates;return e.proveNotNull.validate(this.addressInfo.prov.value)&&e.cityNotNull.validate(this.addressInfo.city.value)},h.testPostCode=function(){switch(this.addressInfo.prov.value){case"710000":case"810000":case"820000":case"990000":return this.validates.specPostCode.validate(this.addressInfo.postCode);default:return this.validates.normalPostCode.validate(this.addressInfo.postCode)}},h.testStreet=function(){return this.validates.street.validate(this.addressInfo.street)},h.testName=function(){return this.validates.name.validate(this.addressInfo.name)},h.testPhone=function(){return this.addressInfo.mobile+this.addressInfo.phone.phoneCode+this.addressInfo.phone.phoneSection+this.addressInfo.phone.phoneExt===""?(this.fire("error",{msg:"电话和手机请至少填写一个"}),!1):(this.fire("success",{msg:"电话和手机请至少填写一个"}),this.addressInfo.phone.phoneCode+this.addressInfo.phone.phoneSection+this.addressInfo.phone.phoneExt?this.validates.phone.validate(this.addressInfo.phone.phoneCode,"phone")&&this.validates.phone.validate(this.addressInfo.phone.phoneSection,"section")&&this.validates.phone.validate(this.addressInfo.phone.phoneExt,"ext")&&this.addressInfo.mobile?this.validates.mobile.validate(this.addressInfo.mobile):!this.fire("cleanMobile"):(this.fire("success",{msg:"区号必须是3-6位数字，主机号码必须是5-10位数字，分机号必须是0-6位数字"}),this.validates.mobile.validate(this.addressInfo.mobile)))},h.test=function(e){var t=this,n=!0;if(e&&e.addressInfo)for(var r in e.addressInfo){switch(r){case"prov":case"city":case"area":n=t.testPosition();break;case"postCode":n=t.testPostCode();break;case"street":n=t.testStreet();break;case"name":n=t.testName();break;case"phone":case"mobile":n=t.testPhone();break;default:}if(!n)return n}else{var i=t.testPosition(),s=t.testPostCode(),o=t.testStreet(),u=t.testName(),a=t.testPhone();n=i&&s&&o&&u&&a}return n},h},{requires:["tc/form/length","tc/form/notNull","tc/form/specPostCode","tc/form/normalPostCode","tc/form/street","tc/form/name","tc/form/phone","tc/form/mobile","ajax","json"]}),KISSY.add("tc/form/specPostCode",function(e,t,n){return t.add("specPostCode",function(e){return/^[0-9a-zA-Z\- ]{0,10}$/.test(e)},"邮政编码仅能由数字、字母、空格和连词符组成")},{requires:["tc/core/form"]}),KISSY.add("tc/form/normalPostCode",function(e,t,n){return t.add("normalPostCode",function(e){return/^\d{6}$/.test(e)},"邮政编码填写有误,请输入6位邮政编码")},{requires:["tc/core/form"]}),KISSY.add("tc/form/street",function(e,t){return t.add("street",function(e){return/^.{5,60}$/.test(e)&&!/^\d+$/.test(e)&&!/^[a-zA-Z]+$/.test(e)},"请填写街道地址，最少5个字，最多不能超过60个字，不能全部为数字或字母")},{requires:["tc/core/form"]}),KISSY.add("tc/form/name",function(e,t){return t.add("name",function(e){return/^.{2,15}$/.test(e)&&!/null/.test(e)},"请正确填写姓名，最少不能低于2个字，最多不能超过15个字，且其中不能含有 null 字样")},{requires:["tc/core/form"]}),KISSY.add("tc/form/phone",function(e,t){var n="区号必须是3-6位数字，主机号码必须是5-10位数字，分机号必须是0-6位数字";return t.add("phone",function(e,t){switch(t){case"section":return n="区号必须是3-6位数字",e.match(/^\d{3,6}$/);case"phone":return n="主机号码必须是5-10位数字",e.match(/^\d{5,10}$/);case"ext":return n="分机号必须是0-6位数字",e.match(/^\d{0,6}$/);default:}},n)},{requires:["tc/core/form"]}),KISSY.add("tc/form/mobile",function(e,t){return t.add("mobile",function(t){return/^\d{2,11}$/.test(e.trim(t))},"请输入正确的号码，手机号码必须全为数字，且不能超过11位")},{requires:["tc/core/form"]}),KISSY.add("tc/mods/addressNew/util/districtSelector",function(e,t,n,r,i){function u(t,n,i){var s=0;t.removeItems(!0),e.each(n,function(e,n){t.addItem(new r.Option({prefixCls:"c2c-",value:e.id,content:e.name})),i==e.id&&(s=n)}),t.set("selectedIndex",s)}function a(e,t){if(e==="1")return;return e in s?(t.unshift({id:e,name:s[e][0]}),a(s[e][1],t,s),t):[]}function f(){var t=[];return e.each(s,function(e,n){e[1]==="1"&&t.push({id:n,name:e[0]})}),t}function l(t){var n=[];return e.each(s,function(e,r){e[1]===t&&n.push({id:r,name:e[0]})}),n}var s=window.tdist?window.tdist:{},o={};return o._init=function(){var e=this},o.getAddress=a,o.getAllProvs=f,o.getSubAddr=l,o.updateAll=function(e){var t=this,n=[];if(!e){t.updateProv();return}var n=a(e,[]);n[0]&&t.updateProv(n[0].id),n[1]&&t.updateCity(n[0].id,n[1].id),n[1]&&n[2]&&t.updateArea(n[1].id,n[2].id)},o.updateProv=function(e){u(this.provMenu,f(),e)},o.updateCity=function(e,t){e&&u(this.cityMenu,l(e),t)},o.updateArea=function(e,t){e&&u(this.areaMenu,l(e),t)},o},{requires:["dom","event","tc/dpl/dropDown"]}),KISSY.add("tc/core/widget",function(e,t,n){var t=e.DOM,n=e.Event,r={};return r.InputHint={decorate:function(r,i){var s={hintMessage:"",hintClass:"tb-input-hint",appearOnce:!1},o=/^\s*$/;r=t.get(r),i=e.merge(s,i||{});var u=i.hintMessage||r.title||"";if(!e.trim(u))return;var a=t.create("<div style='position:relative;display:inline-block;*display:inline;*zoom:1;'>");t.insertBefore(a,r),a.appendChild(r);var f={};f.disabled=!1;var l=(new e.Node("<div style='position:absolute;left:-9999px;top:-9999px;' class='"+i.hintClass+"'>"+u+"</div>")).insertAfter(r);l.css("width",r.offsetWidth),f.disappear=function(){l.offset({left:-9999,top:-9999})},f.appear=function(){if(o.test(r.value)){var e=t.offset(r);e.left+=5,l.offset(e)}},f.purge=function(){this.disappear(),n.remove(r,"focus",c),n.remove(r,"drop",c),n.remove(r,"blur",h)};var c=function(e){r.focus(),f.disabled||f.disappear()},h=function(e){f.disabled||f.appear()};return r.title||t.attr(r,"title",u),n.on([r,l[0]],"focus",c),n.on(r,"drop",c),i.appearOnce||n.on(r,"blur",h),setTimeout(function(){f.appear()},0),f}},r},{requires:["dom","event"]}),KISSY.add("tc/mods/addressNew/util/postCodeSelector",function(e,t){return{_init:function(){var t=e.mix(this,this.config);t.postCodeEl=t.postCodeEl||e.get("#J_postCode")},getPostCode:function(e,n){var r=this;if(!e){console.warn("[postCodeSelector]: divisionId is undefined");return}t.post(r.postCodeAPI,{divisionid:e},function(e){r.postCodeEl&&(e||(e=""),r.postCodeEl.value=e),n&&n()})}}},{requires:["ajax"]}),KISSY.add("tc/mods/addressNew/util/addressPopup",function(e,t,n,r){var i={};return i._init=function(){e.mix(this,this.config);var n=this,r=n.offset,i=n.target;n.addressPopup=new t({srcNode:i,mask:!0,xy:[r.left,r.top],align:{node:"#address",points:["tl","tl"],offset:[0,0]}}),n.addressPopup.render(),n.addressPopup.hide()},e.mix(i,{show:function(e){this.fire("beforeShow"),e&&(e.left&&this.addressPopup.set("x",e.left),e.top&&this.addressPopup.set("y",e.top)),this.addressPopup.show(),this.fire("afterShow")},hide:function(){this.fire("beforeHide"),this.addressPopup.hide(),this.fire("afterHide")}}),i},{requires:["overlay","ua","dom"]}),KISSY.add("tc/mods/tools/textDraw/textDraw",function(e,t,n){return{_init:function(){e.query("#content input, #content textarea").each(function(e){if(e.tagName=="INPUT"&&e.type!="text")return;t.addClass(e,"c2c-text-default"),n.on(e,"focus",function(e){t.addClass(e.target,"c2c-text-focus")}),n.on(e,"blur",function(e){t.removeClass(e.target,"c2c-text-focus")}),n.on(e,"mouseover",function(e){var n=e.target;(n.tagName=="INPUT"||n.tagName=="TEXTAREA")&&t.addClass(e.target,"c2c-text-hover")}),n.on(e,"mouseout",function(e){var n=e.target;(n.tagName=="INPUT"||n.tagName=="TEXTAREA")&&t.removeClass(e.target,"c2c-text-hover")})})}}},{requires:["dom","event"]}),KISSY.add("tc/mods/promoHint/ui",function(e){var t={};return t._init=function(){e.each(e.query("#J_OrderTable ul.J_ScrollingPromoHint"),function(t){e.query("li",t).length&&e.Slide(t,{markupType:2,panels:e.query("li",t),hasTriggers:!1,effect:"scrolly",interval:3,duration:.5})})},t},{requires:["switchable"]}),KISSY.add("tc/mods/point/ui",function(e,t,n,r,i){return{_init:function(){var n=e.mix(this,this.config);n.logic=new i({point:parseInt(n.pointEl.innerHTML||"0",10),usePoint:e.trim(n.useEl.value||0),maxUse:n.initMaxPoint||0,groups:n.groups});var r=e.get("div.msg",n.useEl.parentNode);n.logic.validates.point.on("error",function(i){e.get("p",r).innerHTML=i.msg,t.show(r),n.priceEl.innerHTML="-0.00"}).on("success",function(){t.hide(r)}),n.logic.validates.maxUse.on("error",function(n){e.get("p",r).innerHTML=n.msg,t.show(r)}).on("success",function(e){t.hide(r)}),n.logic.maxUseRule.on("selfUpdateComplete",function(e){n.renderData(),n.bindEvents()}),n.listen("usepoint-reset",function(e){n.resetPoint()},["global"])},renderData:function(){var e=this;e.maxPriceEl.innerHTML=(e.logic.maxUse/100).toFixed(2),e.maxUseEl.innerHTML=e.logic.maxUse.toFixed(0);var t=e.logic.usePoint/100;t=isNaN(t)?0:t,e.priceEl.innerHTML="-"+t.toFixed(2)},bindEvents:function(){var e=this;n.on(e.useEl,"keyup",e.pointChangeHandler,e),e.from==="cart"&&e.listen("toggle-cod",function(n){var r=!1;n.from==="cod"&&(r=n.isCod),t[r?"addClass":"removeClass"](e.useEl,"input-disabled"),t.attr(e.useEl,"disabled",r),t.attr(e.useEl,"readonly",r),r&&(e.useEl.value=0,e.pointChangeHandler())},["global"]),e.listen("global-test",function(){return e.logic.test()},["global"]),e.bindEvents=function(){}},pointChangeHandler:function(){var t=this;t.logic.change({usePoint:e.trim(t.useEl.value||0)})&&t.renderData()},resetPoint:function(){var e=this;e.useEl.value=0,e.logic.change({usePoint:0})&&e.renderData()}}},{requires:["dom","event","tc/core/common","tc/mods/point/point"]}),KISSY.add("tc/mods/point/point",function(e,t,n,r){var i={};return i.validates={point:new t,maxUse:new n},i._init=function(){var t=e.mix(this,this.config);t.rule=r.add("point",function(e){return-e.point},{groups:t.groups}),t.maxUseRule=r.add("maxUsePoint",function(e,t){return console.log("[stepPayShopTotal]:%s",t),t>0?parseInt((t*100).toFixed(0),10):parseInt((e*100).toFixed(0),10)},{parents:["b2cShopTotal","stepPayShopTotal"],groups:t.groups}),t.maxUseRule.on("parentUpdate",function(e){if(e.name!=="b2cShopTotal")return;return r.sum(e.parent)}),t.maxUseRule.on("selfUpdate",function(e){console.log("[maxUsePoint]: "+e.result),t.maxUse=e.result>t.point?t.point:e.result,t.maxUseRule.fire("selfUpdateComplete")}),t.validates.point.on("error",function(){t.rule.update({point:0})}),t.validates.maxUse.on("error",function(){t.rule.update({point:0})})},i.test=function(){return this.validates.point.validate(this.usePoint)&&this.validates.maxUse.validate(this.usePoint,this.maxUse)},i.change=function(t){var n=e.mix(this,t),r=n.test();return r&&n.rule.update({point:n.usePoint/100}),r},i},{requires:["tc/form/point","tc/form/compareNum","tc/core/rule"]}),KISSY.add("tc/form/point",function(e,t){return t.add("point",function(e){return e||(e=0),/^\d+$/.test(e)&&e>=0},"使用商城积分点数必须为大于0的整数")},{requires:["tc/core/form"]}),KISSY.add("tc/mods/checkCode/ui",function(e,t,n,r,i,s){var o={};return o._init=function(){var t=e.mix(this,this.config),o=n.get(this.img||"#J_verifyImage"),u=t.checkCodeEl=n.get(this.checkCode||"#verify-code"),a=n.get(this.nextCode||"#J_verifyTrigger"),f=this.checkCodeUrlEl?this.checkCodeUrlEl:n.get("#J_checkCodeUrl"),l=this.dplStyle||!1;if(!u){console.log("[checkcode]: checkCode is not use..");return}f||t.remoteVerify&&f?t.remoteVerify=!0:(t.remoteVerify=!1,console.log("[checkcode]: checkCode remoteVerify is not use.."));var c=new s({checkCode:{value:u.value}});t.remoteVerify&&(t.checkCodeURL=f.value),t.logic=c,t.checkCodeEl=u,r.on(a,"click",function(e){e.halt(),o.src=o.src+"&t="+(new Date).getTime()});var h=c.validates;h.checkCodeNotNull.on("error",function(e){i[l?"dplError":"error"](u.parentNode,"请填写校验码")}).on("success",function(t){e.later(function(){i[l?"clearDplErr":"clearErr"](u.parentNode,"请填写校验码")},500,!1)}),r.on(u,"blur",function(){c.change({checkCode:{value:u.value}})}),t.listen("global-test",function(){return c.change({checkCode:{value:u.value}})}),t.listen("checkCode",function(){t.remoteVerify&&t.verifyCode()})},o.verifyCode=function(){var r=this,s=r.checkCodeURL,o=n.get(r.formEl?r.formEl:"#J_Form").elements;if(!o.isCheckCode)return;var u=[];e.each(["isCheckCode","encrypterString","sid","gmtCreate","checkCodeIds"],function(e){u.push(e+"="+(o[e]&&o[e].value))}),s=s+(s.indexOf("?")===-1?"?":"&")+u.join("&"),s+="&checkCode="+e.trim(r.checkCodeEl.value),t.get(s,function(t){if(e.trim(t)!=="error")o.newCheckCode?o.newCheckCode.value=t:n.create('<input type="hidden" name="newCheckCode" value="'+t+'" />'),r.broadcast("checkCode:success");else{i[r.dplStyle?"dplError":"error"](r.checkCodeEl.parentNode,"请填写正确的校验码");var s=n.get(this.img||"#J_verifyImage");s.src=s.src+"&t="+(new Date).getTime()}})},o},{requires:["ajax","dom","event","tc/core/common","tc/mods/checkCode/checkCode"]}),KISSY.add("tc/mods/checkCode/checkCode",function(e,t,n){var r={checkCode:{value:""},validates:{checkCodeNotNull:new n}};return r._init=function(){e.mix(this,this.config);var t=this},r.test=function(){return this.validates.checkCodeNotNull.validate(this.checkCode.value)},r.change=function(t){return e.mix(this,t,!0),this.test(t)},r},{requires:["tc/form/length","tc/form/notNull"]}),KISSY.add("tc/mods/updateCart/ui",function(e,t,n,r){var i=e.get("#unable-buy table"),s=e.get("#J_OrderTable"),o=function(t){var n={};e.query(".J_Shop",i).each(function(e){n[e.getAttribute("data-outorderid")]=e}),e.query(".J_Shop",s).each(function(i){var s=i.getAttribute("data-outorderid");if(t[s]){var o=t[s],f=n[s];f||(f=u(i)),e.query(".item",i).each(function(t){e.each(o,function(e){t.getAttribute("data-lineid")===e.itemId+":"+e.skuId&&(a(t,f,e.cantByReason),r.show("#unable-buy"))})})}}),e.query(".J_Shop",s).each(function(t){e.query(".item",t).length||r.remove(t)}),e.query(".J_Shop",s).length||(e.one(".back",s).appendTo(r.create('<div style="text-align: right;"></div>')).parent().appendTo("#J_Form"),r.remove(s.parentNode))},u=function(t){var n=t.cloneNode(!1);return n.appendChild(e.get(".shop",t)),i.appendChild(n),n},a=function(t,n,r){e.get(".s-agio",t).innerHTML='<em tabindex="0">'+r+"</em>",n.appendChild(t)},f=function(t){var n=[];return e.query(".J_Shop",t).each(function(t){var r=[],i=t.getAttribute("data-outorderid");e.query(".item",t).each(function(e){r.push(e.getAttribute("data-lineid"))}),n.push(i+"_"+r.join(","))}),n.join("|")},l=function(t){e.all('<form method="post" id="J_Refresh" action="/auction/order/confirm_order.htm"></form>').appendTo(e.one("body"));var n='<input type="hidden" name="{key}" value="{value}" />',r=[];for(var i in t)r.push(e.substitute(n,{key:i,value:t[i]}));e.one("#J_Refresh").append(r.join("")),e.get("#J_Refresh").submit()},c={_init:function(){var r=e.mix(this,this.config);r.listen("address-change",function(o){var u=e.get("#paramString").value,a={},c=e.get("#J_OrderInfoString")?e.get("#J_OrderInfoString").value:"",h=u.split("&");e.each(h,function(e){var t=e.split("=");a[t[0]]=t[1]}),a.valid=f(s),a.invalid=f(i),a.addressId=o.addressInfo.addressId,a.areaCode=o.addressInfo.area.value,a.orderInfoString=c,o.addressInfo.daiShouHuo&&(a.selfCarry="true"),t.post(r.updateOrderAPI,a,function(e){e=n.parse(e),e.changed&&(e.invalidItemRemoved?(console.info("ready reload page"),a.ah=o.addressInfo.addrDetailString,l(a)):e.invalidItemAdded&&(a.ah=o.addressInfo.addrDetailString,l(a))),r.broadcast("updateOrder-success",{addressInfo:o.addressInfo})})})}};return c},{requires:["ajax","json","dom"]}),KISSY.add("tc/mods/winPoints/showWinPoint-ui",function(e,t,n,r){var i={};return i._init=function(){var t=e.mix(this,this.config);t.logic=new n({groups:t.groups}),t.logic.rule.on("selfUpdate",function(e){r.html(t.winPointEl,e.result)})},i},{requires:["dom","tc/mods/winPoints/showWinPoints","tc/core/domcache"]}),KISSY.add("tc/mods/winPoints/showWinPoints",function(e,t){var n={};return n._init=function(){var n=e.mix(this,this.config);n.rule=t.add("cartWinPoint",function(e,t){return e+t.crossShopPoint},{parents:["shopWinPoint"],groups:n.groups,vars:{crossShopPoint:0}}),n.rule.on("parentUpdate",function(e){if(e.name!=="shopWinPoint")return;return t.sum(e.parent)})},n},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/makePoint/makePoint",function(e,t,n,r){return{_init:function(){var e=this;this.listen("make-point",function(t){t.url&&e.request(t.url)})},request:function(e){var t=document.getElementById("J_ImageDot");t||(t=new Image,t.id="J_ImageDot",t.style.display="none",document.body.appendChild(t));var n=(new Date).getTime();e=e+"&cache="+n,t.src=e}}},{requires:["dom","event"]}),KISSY.add("tc/mods/pointBuy/cartPointBuy-ui",function(e,t,n){return{_init:function(){var r=e.mix(this,this.config),i=r.pointBuyCastEL;r.cartPointBuy=new t({groups:r.groups}),r.cartPointBuy.on("cartPointBuy",function(e){e.pointValue==0?(n.hide(i.parentNode),n.show(n.get("#J_AvailablePoints").parentNode)):i&&(i.innerHTML=e.pointValue,n.show(i.parentNode),n.hide(n.get("#J_AvailablePoints").parentNode)),r.broadcast("usepoint-reset",{from:"pointbuy"},["global"])})}}},{requires:["tc/mods/pointBuy/cartPointBuy","dom"]}),KISSY.add("tc/mods/pointBuy/cartPointBuy",function(e,t){return{_init:function(){var n=e.mix(this,this.config);n.rule=t.add("cartPointBuy",function(e){return e},{parents:["shopPointBuy"],groups:n.groups}),n.rule.on("parentUpdate",function(e){if(e.name!=="shopPointBuy")return;return t.sum(e.parent)}),n.rule.on("selfUpdate",function(e){n.fire("cartPointBuy",{pointValue:e.result})})}}},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/xcard/ui",function(e,t,n,r){var i=600;return{_init:function(){var s=e.mix(this,this.config),o=this.config.xcardEl?this.config.xcardEl:t.get("#J_XCardPay"),u=this.config.xcardAreaEl?this.config.xcardAreaEl:t.get("#J_XCardArea");s.statusCalc=new r(function(e){return e.cod||e.priceLimit||e.isPayAnotherChecked},{vars:{cod:!1,priceLimit:!1,isPayAnotherChecked:!1}}),n.on(o,"click",function(e){t[e.target.checked?"show":"hide"](u),s.broadcast("toggle-xcard",{from:"xcard",isXCardChecked:e.target.checked},["global"])});var a;n.on(e.one(o).parent(),"mouseenter mouseleave",function(t){t.type==="mouseenter"?s.priceLimit&&(a&&a.cancel(),a=e.later(function(){e.one("#J_XCardPriceLimitTip").addClass("flow").show()},500)):s.priceLimit&&(a&&a.cancel(),e.one("#J_XCardPriceLimitTip").removeClass("flow").hide())}),s.listen("toggle-cod realpay-change toggle-payAnother",function(e){if(e.from==="cod")s.statusCalc.update({cod:e.isCod});else if(e.from==="realpay"){var n=s.priceLimit=e.realpay<i;s.statusCalc.update({priceLimit:n}),s.broadcast("xcard-priceLimit",{from:"xcard-priceLimit",isXCardChecked:o.checked,priceLimit:n},["global"])}else e.from==="payAnother"&&s.statusCalc.update({isPayAnotherChecked:e.isPayAnotherChecked});t.attr(o,"disabled",s.statusCalc.result),s.statusCalc.result&&(o.checked=!1,t.hide(u))},["global"])}}},{requires:["dom","event","tc/core/statusCalc"]}),KISSY.add("tc/core/statusCalc",function(e){var t=function(t,n){var r=this,i=e.merge({},n);r._vars=i.vars||{},r._calc=t||function(){return 0},r.update()};return e.augment(t,{add:function(e,n){return new t(e,{vars:n})},update:function(t){var n=this;return e.mix(n._vars,t),n.result=n._calc.call(n,n._vars),n.result}}),t}),KISSY.add("tc/mods/payForAnother/cart-ui",function(e,t,n,r){var i={};return i._init=function(){var i=this,s=this.config.payForAnotherEl?this.config.payForAnotherEl:t.get("#J_PayAnother");if(!s)return;i.statusCalc=new r(function(e){return e.cod?!0:e.priceLimit&&!e.isXCardChecked?!1:e.cod||e.isXCardChecked},{vars:{cod:!1,isXCardChecked:!1,priceLimit:!1}}),n.on(s,"click",function(e){i.broadcast("toggle-payAnother",{from:"payAnother",isPayAnotherChecked:e.target.checked},["global"])}),i.listen("toggle-cod toggle-xcard xcard-priceLimit",function(e){e.from==="cod"?i.statusCalc.update({cod:e.isCod}):e.from==="xcard"?i.statusCalc.update({isXCardChecked:e.isXCardChecked}):e.from==="xcard-priceLimit"&&i.statusCalc.update({priceLimit:e.priceLimit,isXCardChecked:e.isXCardChecked}),t.attr(s,"disabled",i.statusCalc.result),i.statusCalc.result&&(s.checked=!1)},["global"]);var o=e.one(s).parent("div.payAnother");e.one("span.payAnother-tip",o)&&e.one("span.payAnother-icon",o).on("mouseenter mouseleave",function(e){t.toggle("span.payAnother-tip",o)})},i},{requires:["dom","event","tc/core/statusCalc"]}),KISSY.add("tc/mods/recover/cart-recover",function(e){return{_init:function(){var t=this,n=e.merge({},t.config.recoverJSON);if(n.promotions){var r=n.promotions,i=t.config.promotion;for(var s in r)i.recoverPromotion(s,r[s])}e.later(function(){if(n.post){var e=n.post;for(var r in e){var i=t.config.orders[r];i&&i.fareUI.recoverSelectedFare(e[r],n.useCod==="true")}}},1e3)}}}),KISSY.add("tc/mods/nav/ui",function(e){return{_init:function(){e.one("#flow-steps .J_CodNav")&&this.listen("toggle-cod",function(t){t.isCod?(e.one("#flow-steps .J_CodNav").show(),e.one("#flow-steps .J_NormalNav").hide()):(e.one("#flow-steps .J_CodNav").hide(),e.one("#flow-steps .J_NormalNav").show())},["global"])}}}),KISSY.add("tc/mods/stepPay/ui",function(e,t,n,r,i,s){var o=['<div class="s-title">{title}</div><div class="s-price">{arrow}<span class="price"><em class="style-normal-small-grey">{price}</em></span></div><div class="s-amount">{quantity}</div><div class="s-agio"><span class="price"><em class="style-normal-small-grey">{discount}</em></span></div><div class="s-total"><span class="price"><em class="style-normal-small-grey">{total}</em></span></div>'].join(""),u="step",a=e.one("#steparea"),f=e.one("tr.step","#J_OrderTable"),l=!e.one("em.J_SubStepActualFee",a);return{_init:function(){var t=e.mix(this,this.config);t.logic=new s(this.config),t.on("stepPay-start",function(){e.all("div.step-info",a).addClass("loading"),e.all("ul",f).addClass("loading")}).on("stepPay-error stepPay-complete",function(n){e.all("div.step-info",a).removeClass("loading"),e.all("ul",f).removeClass("loading"),t.broadcast("getService",{from:n.method||"changePromotion"},["global"])}),t.objects={}},createStepPay:function(t,n){var r=this,i=r.logic.base(t,n,l);return e.mix(i,{oid:t}),i.update(r.initPrice*1||0),i.updatePoint({subTotalFee:r.initMaxPoint||0,shopPromo:0}),i.rule.on("selfUpdate",function(e){r.updateSerivce(i)}),r.objects[t]=i,i},update:function(e,t){var n=this;n.request&&n.request.abort(),n.fire("stepPay-start"),n.request=r({type:"POST",url:n.stepPayAPI,data:e,success:function(e){try{e=i.parse(e)}catch(r){console.error("[stepPay]: Data Parse Error, %s",r.message),e={},n.fire("stepPay-error",{method:t})}e.stepPays?n.render(e):(console.error("[stepPay]: stepPay format Error, %s",e.message),n.fire("stepPay-error",{method:t}))},error:function(){n.request.status==0&&n.fire("stepPay-error",{method:t})},complete:function(){n.fire("stepPay-complete",{method:t})},timeout:5e3})},render:function(t){var n=this,r=t.current,i=n.objects[t.oid];if(r&&t.stepPays[r]){var s=t.stepPays[r];l||(e.one("em.J_SubStepUnitPrice",a).html((s.subTotalFee/100).toFixed(2)),e.one("em.J_SubStepShopPromotionDis",a).html("- "+(s.shopDisFee/100).toFixed(2))),i.update(s.actualFee/100),i.updatePoint({subTotalFee:s.subTotalFee/100,shopPromo:s.shopDisFee/100})}f&&e.query("li.substep ",f).each(function(n,r){var i=t.stepPays[u+(r+1)];i&&(n.innerHTML=e.substitute(o,{title:i.title,price:isNaN(i.unitPrice/100)?i.unitPrice:(i.unitPrice/100).toFixed(2),quantity:t.quantity,discount:"-"+(i.itemDisFee/100).toFixed(2)||"-",total:isNaN(i.subTotalFee/100)?i.subTotalFee:(i.subTotalFee/100).toFixed(2),arrow:r==0?"<i></i>":""}))})},updateSerivce:function(t){l||(e.one("em.J_SubStepServiceFee",a)&&e.one("em.J_SubStepServiceFee",a).html(t.otherRule.result.toFixed(2)),e.one("em.J_SubStepActualFee",a)&&e.one("em.J_SubStepActualFee",a).html(t.rule.result.toFixed(2)),e.one("em.J_deposit")&&e.one("em.J_deposit").html(t.rule.result.toFixed(2)))}}},{requires:["dom","event","ajax","json","./stepPay"]}),KISSY.add("tc/mods/stepPay/stepPay",function(e,t){function n(e,n,r){var i=this;i.rule=t.add("stepShopPay",function(e,t){return n?0:t.price*1+e*1},{groups:e,parents:["otherFee"],vars:{price:0}}),i.maxPointRule=t.add("stepPayShopTotal",function(e){return e.unintPrice+e.shopPromo},{groups:e,vars:{unintPrice:0,shopPromo:0}}),i.otherRule=t.add("otherFee",function(e,t){return console.warn("otherFee = stepService(%s) + fare(%s)",e,t),r==1?e*1+t*1:e*1},{groups:e,parents:["stepService","fare"]}),i.otherRule.on("parentUpdate",function(e){if(e.name!=="stepService")return;return t.sum(e.parent)})}return e.augment(n,{update:function(e){this.rule.update({price:e*1})},updatePoint:function(e){this.maxPointRule.update({unintPrice:e.subTotalFee*1,shopPromo:-(e.shopPromo*1)})}}),e.augment(n,e.EventTarget),{_init:function(){var t=e.mix(this,this.config)},base:function(t,r,i){var s=this;return e.mix(new n(r,i,s.fareStepPayNo[t]),{oid:t})}}},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/service/cart-ui",function(e,t,n,r,i,s,o,u,a){var f="text",l="select",c="hidden",h="step",p={};return p=e.merge(p,{_init:function(){e.mix(this,this.config);var t=this;t.servicePool={},t.serviceLogic=new o({data:t.data,groups:t.groups}),t.on("service-start",function(t){e.all(".servicearea").addClass("loading")}).on("service-error service-success",function(t){e.all(".servicearea").removeClass("loading")}),t.serviceLogic.on("update-service",function(n){var r=n.updateList;r.length&&(e.each(r,function(e,n){var r=e[0],i=e[1],s=e[2];t._refresh(t.servicePool[r][i],r,i,s)}),e.each(r,function(e){var n=e[0],r=e[1],i=e[2];(i==="update"||i==="add")&&t.broadcast(n+":serviceChange",{sid:r,method:i})}))}),e.each(t.TPL,function(e,n){t.TPL[n]=r(e).render})},_render:function(t,n,r){var s=this;if(!n)return;var o=s.serviceLogic.data.groups,u=s.serviceLogic.data.orders[t.oid],a,f,c=!1,h;n.group?(c=!0,h=n.group):h=t.sid+"_"+t.oid,f=document.getElementById(["J_ServiceGroup_",h].join("")),f=e.one(f),f||(f=e.one("li.content",i(s.TPL.container({idx:r,title:c?o[h].title:n.title,group:h})).appendTo(t.container)));var p={price:(n.price*1/100).toFixed(2),sid:t.sid,oid:t.oid};if(n.type===l){var d;e.each(n.subServiceList,function(e){e.selected&&(d=e)}),d||(n.readonly?d=n.subServiceList[0]:d=s._getSelectedData(-1,n,t)),p=e.merge(p,{options:n.subServiceList,price:(d.price*1/100).toFixed(2),desc:d.desc})}return a=i(s.TPL[n.type](e.merge(n,p))).appendTo(f),e.mix(t,{groupEl:f,serviceEl:a}),a},_initDOM:function(t,n,r){if(!n)return;var i=e.one("em",e.one("span.price",r)),s=this,o=s.serviceLogic.data.services,a=o[t.sid];if(n.type===f)e.one("input",r).on("click",function(e){e.target.checked?(i.replaceClass("style-normal-bold-grey","style-normal-bold-red"),n.selected=!0,t.update(n.price,t.currentStep)):(i.replaceClass("style-normal-bold-red","style-normal-bold-grey"),n.selected=!1,t.update(0,t.currentStep)),s._updateServiceText(t.container),a&&a.request&&s.broadcast("getService",{oid:t.oid,sid:t.sid})}),s._showDesc(r,n.desc,t,!!n.url),t.update(n.selected?n.price:0,t.currentStep);else{var l=t.menu=new u.Select.decorate(e.one("select",r),{prefixCls:"c2c-"});l.on("afterSelectedItemChange",function(o){var u=this.get("selectedIndex"),f=o.target.value,l=s._getSelectedData(f,n,t);t.update(l.price,t.currentStep),e.each(n.subServiceList,function(e){e.selected=!1}),l.selected=!0,i.html((l.price/100).toFixed(2)),f==-1?i.replaceClass("style-normal-bold-red","style-normal-bold-grey"):i.replaceClass("style-normal-bold-grey","style-normal-bold-red"),s._showDesc(r,l.desc,t,!!n.url),s._updateServiceText(t.container),a&&a.request&&s.broadcast("getService",{oid:t.oid,sid:t.sid})});var c=s._getSelectedData(l.get("value"),n,t);s._showDesc(r,c.desc,t,!!n.url),t.update(c.price,t.currentStep),l.get("value")==-1?i.replaceClass("style-normal-bold-red","style-normal-bold-grey"):i.replaceClass("style-normal-bold-grey","style-normal-bold-red")}a&&a.trigger&&e.each(a.trigger,function(n,r){e.each(n,function(e){s.broadcast(e+":toggle",{type:r,oid:t.oid})})})},_getSelectedData:function(t,n,r){if(t==-1)return{price:0,desc:""};var i;return e.each(n.subServiceList,function(e,n){if(r.sid+":"+e.id===t)return i=e,!1}),i},_showDesc:function(t,n,r,s){var o=this,u=e.one("div.c2c-desc-container",t);u&&u.remove();var f=e.one(document.getElementById("J_Desc_service_"+r.oid+"_"+r.sid));f&&f.remove();if(!n){r.type===l&&s&&e.one("select",t).next("a").css("marginLeft","0");return}r.type===l?(u=i(o.TPL.trigger({extraClass:s?"shift-trigger":undefined})).appendTo(e.one("select",t).parent()),s&&e.one("select",t).next("a").css("marginLeft","15px")):u=i(o.TPL.trigger({extraClass:s?"shift-trigger":undefined})).appendTo(e.one("input",t).parent()),f=i(o.TPL.desc({desc:n,oid:r.oid,type:"service",feature:r.sid})).appendTo(document.body);var c=u.getDOMNode(),h={node:e.one("span.c2c-desc-trigger",c),points:["bl","tl"],offset:[-20,10]};(new a.Popup(f,{trigger:e.one("span.c2c-desc-trigger",c),triggerType:"mouse",align:h})).on("beforeVisibleChange",function(t){t.attrName==="visible"&&t.target.set("align",e.merge(h))})},_refresh:function(t,n,r,i){var s=this;if(!e.isUndefined(t)||i!=="add"){var o=t.groupEl,u=t.serviceEl;i==="delete"?(t.update(0,t.currentStep),u.remove(),o.children("div").length||(o.parent(".service").remove(),e.all(".service",t.container).length||t.container.hide()),s._updateServiceText(t.container),t=null,delete s.servicePool[n][r]):i==="update"&&(t.update(0,t.currentStep),u.remove(),t=null,delete s.servicePool[n][r])}},_updateServiceText:function(t){e.throttle(function(t){var n=e.one("span.J_ServiceText",e.one(t).parent("tbody"));n&&(e.all("em.style-normal-bold-red",e.all(".servicearea",e.one(t).parent("tbody"))).length?n.show():n.hide())}(t))}}),p.createServices=function(t,n,r,i){var s=this,o=0;s.serviceLogic.data.orders[t]||(s.serviceLogic.data.orders[t]={services:{}});var u=s.serviceLogic.data.orders[t];s.servicePool[t]||(s.servicePool[t]={});var a=s.servicePool[t];if(u&&!e.isEmptyObject(u.services)){var f=u.type===h;f&&t.indexOf("b_")!=0&&(n=n[u.currentStep-1]),e.each(u.services,function(l,h){var p=s.serviceLogic.base(h,t,r,i);e.mix(p,{container:n,oid:t,isStepPay:f,currentStep:u.currentStep||0,type:l.type}),p.isStepPay&&p.attachStepRule(r);var d=s._render(p,l,o);l.type!==c?s._initDOM(p,l,d):p.groupEl.parent().hide(),a[h]=p,o++}),e.one(n).show()}else e.one(n).hide();s._updateServiceText(n)},p.createService=function(t,n,r,i,s){var o=this;o.servicePool[t]||(o.servicePool[t]={});var u=o.servicePool[t],a=o.serviceLogic.data.orders[t],f=o.serviceLogic.base(n,t,i,s),l=a.type===h;l&&t.indexOf("b_")!=0&&(r=r[a.currentStep-1],f.attachStepRule(i));var p=a.services[n];e.mix(f,{container:r,oid:t,isStepPay:l,currentStep:a.currentStep||0,type:p.type});var d=o._render(f,p,1);p.type!==c?o._initDOM(f,p,d):f.groupEl.parent().hide(),u[n]=f,e.one(r).show(),o._updateServiceText(r)},p.update=function(t,n){var r=this;r.request&&r.request.abort(),r.fire("service-start"),r.request=s({type:"POST",url:r.api,data:{from:r.from||"unity",m:t||"changeservice",ordersData:JSON.stringify(n),t:e.now()},success:function(e){try{e=JSON.parse(e)}catch(t){console.warn("[service]: Data Parse Error, %s",t.message),e={},r.fire("service-error")}e.result==="success"?(r.serviceLogic.merge(e.data),r.fire("service-success")):(console.warn("[service]: Service Request Error, msg = %s",e.message),r.fire("service-error"))},error:function(){r.request.status==0&&(console.warn("[service]: Service Request Error, status = %s",r.request.status),r.fire("service-error"))},timeout:5e3})},p},{requires:["dom","event","template","node","ajax","./service","tc/dpl/dropDown","overlay"]}),KISSY.add("tc/mods/service/service",function(e,t){function n(e,n){this.rule=t.add(n,function(e){return e.price},{groups:e,vars:{price:0}})}e.augment(n,{update:function(e,t){this.rule.update({price:e*1}),this.stepRule&&t==1&&this.stepRule.update({price:e/100})},attachStepRule:function(e){this.stepRule=t.add("stepService",function(e){return e.price},{groups:e,vars:{price:0}})}});var r={};return r=e.merge(r,{base:function(e,t,r,i){var s=new n(r,i);return s.sid=e,s},merge:function(t){var n=this,r=t.orders,i=[];e.mix(n.data,t,!0,["groups","services"]),e.each(n.data.orders,function(t,n){r[n]||(r[n]={services:{}});var s=r[n].services,o=t.services;e.each(o,function(t,r){e.isEmptyObject(s[r])?e.isUndefined(s[r])&&(delete o[r],console.warn("delete service oid=%s sid=%s",n,r),i.push([n,r,"delete"])):(e.mix(t,s[r],!0),i.push([n,r,"update"]))}),e.each(s,function(e,t){o[t]||(o[t]=s[t],i.push([n,t,"add"]))})}),n.fire("update-service",{updateList:i})}}),r=e.merge(r,{_init:function(){var t=e.mix(this,this.config)}}),r},{requires:["tc/core/rule"]}),KISSY.add("tc/mods/generQRCode/cart-ui",function(e,t,n,r,i){var s={};return s._init=function(){var s=e.mix(this,this.config),o={friend:t.get("#J_Present .J_ToFriend"),mySelf:t.get("#J_Present .J_ToMyself"),friendUl:t.get("#J_ToFriend"),mySelfUl:t.get("#J_ToMySelf"),presentInfo:t.get("#J_PresentInfo")};for(var u in o)o[u]||(console.warn("[generQRCode/ui] element %s not found. delete it.",u),delete o[u]);var a={friendMob:t.get("#J_friendMob"),friendMobRepeat:t.get("#J_SureFriendMobile"),mySelfMob:t.get("#J_MyMobile"),mySelfMobRepeat:t.get("#J_SureMyMobile"),name:t.get("#J_Name")};for(var u in a)a[u]||(console.warn("[generQRCode/ui] inputElement %s not found. delete it.",u),delete a[u]);var f=!!e.one("#J_Name"),l=9,c={mySelfMob:{el:"mySelfMob"},mySelfMobRepeat:{el:"mySelfMobRepeat"},friendMob:{el:"friendMob"},friendMobRepeat:{el:"friendMobRepeat"},nameNotNull:{el:"name",msg:"姓名或昵称不能为空"},nameLength:{el:"name",msg:"最多可输入9个字"}},h=function(n){if(!n)return;e.each(t.query("input",n),function(e){e.id!="J_Benediction"&&(e.value="")})},p={friendMob:{value:e.trim(a.friendMob.value)},friendMobRepeat:{value:e.trim(a.friendMobRepeat.value)},name:{value:e.trim(a.name.value)},identityCard:{value:""},identityCardRepeat:{value:""},to:"friend",NAME_LENGTH:l,eticketStepBuy:s.eticketStepBuy},d=new r(p),v=function(n){n?(t.addClass(o.friendUl,"hidden"),t.removeClass(o.mySelfUl,"hidden"),t.addClass(o.presentInfo,"hidden"),i.clearErr(o.friendUl),h(o.friendUl),d.setData({mySelfMob:{value:e.trim(a.mySelfMob.value)},mySelfMobRepeat:{value:e.trim(a.mySelfMobRepeat.value)},friendMob:{value:""},friendMobRepeat:{value:""},name:{value:""},to:"myself"})):(t.removeClass(o.friendUl,"hidden"),t.addClass(o.mySelfUl,"hidden"),t.removeClass(o.presentInfo,"hidden"),i.clearErr(o.mySelfUl),h(o.mySelfUl),d.setData({mySelfMob:{value:""},mySelfMobRepeat:{value:""},friendMob:{value:e.trim(a.friendMob.value)},friendMobRepeat:{value:e.trim(a.friendMob.value)},name:{value:e.trim(a.name.value)},to:"friend"}))};o.mySelf.checked&&v(!0),o.friend.checked&&v(!1);var m=d.validates,g=function(e){var t=c[e].el,n=a[t];if(!n)console.log("tc/mods/generPhone/ui element： "+t+" not exist");else{var r=c[e].msg;m[e].on("error",function(e){i.error(n.parentNode,r||e.msg)}).on("success",function(e){i.clearErr(n.parentNode,r||e.msg)})}};for(var y in c)g(y);e.each(a,function(t){n.on(t,"blur",function(t){var n,r={};for(var i in a)t.target===a[i]&&(r[i]={value:e.trim(a[i].value)},n=i);d.change(r),s.eticketStepBuy&&(e.one("#J_eTicketPhoneError").hide(),e.one("#J_eTicketNameError").hide())})}),n.on("#J_Present","click",function(e){var n=e.target;t.hasClass(n,"J_ToMyself")&&v(!0),t.hasClass(n,"J_ToFriend")&&v(!1)}),this.listen("qrCodeTestForStepBuy",function(t){s.eticketStepBuy&&(e.one("#J_eTicketPhoneError").hide(),e.one("#J_eTicketNameError").hide(),t.mobile===!1&&e.one("#J_eTicketPhoneError").show(),t.name===!1&&e.one("#J_eTicketNameError").show())}),this.listen("mobile-test",function(e){s.eticketStepBuy&&(e.pass?t.get("#J_phoneConfirm").innerHTML=e.value:t.get("#J_phoneConfirm").innerHTML="")})},s},{requires:["dom","event","tc/mods/generQRCode/generQRCode","tc/core/common"]}),KISSY.add("tc/mods/generQRCode/generQRCode",function(e,t,n,r,i,s){var o={mySelfMob:new t,mySelfMobRepeat:new r,friendMob:new t,friendMobRepeat:new r,nameNotNull:new s,nameLength:new n({max:9}),identityCard:new i,identityCardRepeat:new r},u={validates:o,isFriend:function(){return this.to==="friend"}};return u._init=function(){e.mix(this,this.config);var t=this;this.listen("global-test",function(){return t.test()})},u.test=function(e){var t=this,n=!0,r=function(){var e,n;return t.isFriend()?(e=o.friendMobRepeat.validate(t.friendMob.value,t.friendMobRepeat.value),n=t.friendMob.value):(e=o.mySelfMobRepeat.validate(t.mySelfMob.value,t.mySelfMobRepeat.value),n=t.mySelfMob.value),t.broadcast("mobile-test",{pass:e,value:n}),e},i=function(){var e;return t.isFriend()?(e=o.friendMob.validate(t.friendMob.value),e&&t.friendMobRepeat.value&&r()):(e=o.mySelfMob.validate(t.mySelfMob.value),e&&t.mySelfMobRepeat.value&&r()),e||t.broadcast("mobile-test",{pass:!1}),e},s=function(){return t.name?o.nameNotNull.validate(t.name.value)&&o.nameLength.validate(t.name.value):(console.warn("[generQRCode]: name not found, return true."),!0)},u=function(){if(!t.identityCard)return console.warn("[generQRCode]: identityCard not found, return true."),!0;var e=o.identityCard.validate(t.identityCard.value);return e&&a(),e},a=function(){return t.identityCardRepeat?o.identityCardRepeat.validate(t.identityCard.value,t.identityCardRepeat.value):(console.warn("[generQRCode]: identityCardRepeat not found, return true."),!0)},f={mySelfMob:i,mySelfMobRepeat:r,friendMob:i,friendMobRepeat:r,name:s,identityCard:u,identityCardRepeat:a};if(e){for(var l in e)l in f?n=n&&f[l]():console.log("xy warning:"+l+" is not in map!!   -------tc/mods/generQRCode/generQRCode");return n}var c=i()&&r(),h=t.isFriend()?s():!0,p=t.to?!0:u()&&a();return console.log("[all test]:"+c+" "+h+" "+p),t.broadcast("qrCodeTestForStepBuy",{mobile:c,name:h}),c&&h&&p},u.setData=function(t){t&&e.mix(this,t)},u.change=function(t){return e.mix(this,t,!0),this.test(t)},u},{requires:["tc/form/mobile2","tc/form/length","tc/form/repeat","tc/form/identityCard","tc/form/notNull"]}),KISSY.add("tc/form/mobile2",function(e,t){return t.add("mobile2",function(t){return/^1[0-9]{10}$/.test(e.trim(t))},"请输入正确的号码，手机号码必须全为数字，且不能超过11位")},{requires:["tc/core/form"]}),KISSY.add("tc/form/repeat",function(e,t){return t.add("repeat",function(t,n){return e.trim(t)===e.trim(n)},"两次输入不一致")},{requires:["tc/core/form"]}),KISSY.add("tc/form/identityCard",function(e,t){return t.add("identityCard",function(e){return/^\d{17}[x0-9X]$|^$/.test(e)},"请输入正确的身份证号")},{requires:["tc/core/form"]}),KISSY.add("tc/cart/cart",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k){var L={_init:function(){var L=e.mix(this,this.config),A="U_1234567890",O=[A];L.postFree={},L.listen("updateOrder-success",function(e){L.broadcast("getPromotion",{from:"changeaddress",addressInfo:e.addressInfo})});var M=function(){var t=r.get("#address")?!0:!1,n=r.get("#J_confirmFill")?!0:!1;return t===!1&&n===!0?(L.GenerQRCode=new C({eticketStepBuy:!0}),new k({target:e.get("#J_friendMob")}),new k({target:e.get("#J_MyMobile")}),!0):!1}();L.listen("getPromotion",function(e){var t=e.addressInfo?e.addressInfo:L.address.getAddressInfo(),n=e.from||"changeaddress",r=t&&t.prov&&t.prov.value;L.promotion.update(e.oid,n,r)}),L.listen("getService",function(t){L.service.update(t.from,e.merge(L.buildServiceParams(),{oid:t.oid,sid:t.sid,isCod:document.getElementById("J_Form").elements.use_cod.value,isStepPay:!!L.stepPayAPI}))}),L.listen("toggle-cod",function(t){t.from==="cod"&&(t.isCod?e.all("div.J_SellerFareInsure").hide():e.all("div.J_SellerFareInsure").show())},["global"]),s.time("global"),new x({groups:O}),new a({submitForm:"#J_Form",submitId:"#J_Go",groups:O}),new u({actualFee:"#J_ActualFee",groups:O}),L.usePoint&&(L.cartWinPointUI=new m({winPointEl:r.get("#J_TotalPoints"),groups:O}),new h({pointEl:r.get("#J_AvailablePoints"),maxUseEl:r.get("#J_MaxUsablePoints"),useEl:r.get("#J_PointsToUse"),priceEl:r.get("#J_Discharge"),maxPriceEl:r.get("#J_AvailableDischarge"),groups:O,from:L.from}),new b({groups:O,pointBuyCastEL:r.get("#J_PointBuyCast")})),L.orderData={};try{L.orderData=e.merge({},n.parse(e.get("#J_OrderInitData").value))}catch(_){console.warn("order init data parse error")}L.serviceData={orders:{}};try{L.serviceData=e.merge({orders:{}},n.parse(e.get("#J_ServiceInitData").value))}catch(_){console.warn("service init data parse error")}L.service=new N({data:L.serviceData,TPL:{text:e.one("#J_ServiceTextTpl").val(),select:e.one("#J_ServiceSelectTpl").val(),hidden:e.one("#J_ServiceHiddenTpl").val(),container:e.one("#J_ServiceContainerTpl").val(),trigger:e.one("#J_C2cTriggerTpl").val(),desc:e.one("#J_C2cDescTpl").val()},api:L.serviceAPI}),L.stepPayAPI&&(L.stepPay=new T({stepPayAPI:L.stepPayAPI,initPrice:L.stepPayFstActualFee,initMaxPoint:L.canUseMaxPoint,fareStepPayNo:L.stepFareNo||{},groups:O})),r.get("#J_XCardPay")&&new w({xcardEl:r.get("#J_XCardPay"),xcardArea:r.get("#J_XCardArea"),groups:O}),new E({payForAnotherEl:r.get("#J_PayAnother"),groups:O}),L.promoData={};try{L.promoData=e.merge({},n.parse(e.get("#J_PromotionInitData").value))}catch(_){console.warn("promotion init data parse error")}L.promoData&&e.each(L.promoData.orders,function(t,n){e.mix(t,L.orderData.orders[n],!1,["buyerId","sellerId","divisionCode"])}),L.promotion=new p({api:L.promoAPI,data:L.promoData,from:L.from}),L.promotion.on("promotion-start",function(){e.all("div.J_Promotion").addClass("loading")}).on("promotion-error",function(){e.all("div.J_Promotion").removeClass("loading")}).on("promotion-complete",function(){e.all("div.J_Promotion").removeClass("loading")}),L.promotion.on("promotion-complete promotion-error",function(e){L.updatePromotionPostFree();if(M)L.broadcast("fare-change",{method:e.method});else{if(!L.fareAPI)return;var r=L.address.getAddressInfo(),i=L.buildFareRequestParamsObj(r);t.post(L.fareAPI,i,function(t){t=n.parse(t),L.renderFare(t),L.broadcast("fare-change",{method:e.method})})}}),L.listen("fare-change",function(e){L.stepPay?L.stepPay.update(L.buildStepPayParams(),e.method):L.broadcast("getService",{from:e.method||"changefare"},["global"])});try{var D=e.merge({},n.parse(e.get("#J_CrossShopPromotionInitData").value));L.crossShopPromotions=D.value,L.usePoint&&L.cartWinPointUI.logic.rule.update({crossShopPoint:D.point*1})}catch(_){console.warn("promotion init data parse error")}s.time("orderUI"),L.orders={},L.crossOrders={},e.all("#J_OrderTable tbody.J_Shop").each(function(t){t=e.one(t);var n=t.attr("data-outorderid");L.orders[n]=new o({orderEl:t,orderId:n,cartId:A,fareAPI:L.fareAPI,promotion:L.promotion,orderData:L.orderData.orders,relations:L.orderData.relation,usePoint:L.usePoint,from:L.from,service:L.service,stepPay:L.stepPay,crossOrders:L.crossOrders,crossId:t.attr("data-crossid"),crossShopPromotions:L.crossShopPromotions})}),s.timeEnd("orderUI"),function(){L.isOrderReady()?e.later(function(){M||L.initFareAndPromo(),i.async=!1},100):(e.later(arguments.callee,300),console.log("[order is not ready yet]: 300"))}(),new v({updateOrderAPI:L.updateOrderAPI,orders:L.orders}),M?L.address={getAddressInfo:function(){return{prov:{value:"110000",name:"北京市"},city:{value:"110100",name:""},area:{value:"110101",name:""},postCode:"100010"}}}:(s.time("addressUI"),L.address=new f({address:"#address",addAddressAPI:L.addAddressAPI,updateAddressAPI:L.updateAddressAPI,setDefaultAddrAPI:L.setDefaultAddrAPI,postCodeAPI:L.postCodeAPI,defaultAddressSelected:L.defaultAddressSelected,deliveryAPI:L.deliveryAPI,updateOrderAPI:L.updateOrderAPI}),s.timeEnd("addressUI")),g.add(function(){new l,new c,new d({img:"#J_verifyImage",checkCode:"#verify-code",nextCode:"#J_verifyTrigger"}),new y}),g.run(),s.timeEnd("global"),e.later(function(){new S({recoverJSON:L.oldOrderInfo,orders:L.orders,promotion:L.promotion})},1e3)},buildFareRequestParamsObj:function(t){var i=this,s={secondDivisionId:t.area&&t.area.value||t.city.value,orderItems:[]},o=0,u;e.all("#J_OrderTable tbody.J_Shop").each(function(t){var n={outOrderId:t.attr("data-outorderid"),postMode:t.attr("data-postMode")||"null",items:[],orderPostFree:i.postFree["b_"+t.attr("data-outorderid")]?i.postFree["b_"+t.attr("data-outorderid")]:!1};e.all("tr.item",t).each(function(t){n.items.push({item:t.attr("data-lineid"),quantity:e.one("input.J_Quantity",t).val(),itemPostFree:i.postFree[t.attr("data-lineid")]?i.postFree[t.attr("data-lineid")]:!1}),u=i.promotion.logic.data.orders[t.attr("data-lineid")],o=u&&u.bundle?u.bundle:""}),s.orderItems.push(n)});if(e.one("#J_actId")){var a=o.match(/\d+(?=_)/);s.activity_id=a&&a.length?a[0]:"",e.one("#J_actId").val(s.activity_id)}s.useSelfCarry=t.daiShouHuo?"true":"false";var f=r.get("#J_Form").elements;for(var l=0;l<f.length;l++){var c=f[l];r.hasClass(c,"J_FareParam")&&(s[r.attr(c,"name")]=r.val(c))}return{json:n.stringify(s)}},buildStepPayParams:function(){var t=this,n={};return e.all("#J_OrderTable tbody.J_Shop").each(function(r){var i=r.attr("data-outorderid");e.all("tr.item",r).each(function(r){n.quantity=e.one("input.J_Quantity",r).val(),n.itemId=r.attr("data-lineid"),n.oid="b_"+i,n.unitPrice=(e.one("em.J_ItemPrice",r).text()*100).toFixed(0),n.shopPromotionDis=t.promotion.objects["b_"+i]?t.promotion.objects["b_"+i].logic.rule.result*-100:0,n.itemPromotionDis=t.promotion.objects[r.attr("data-lineid")]?t.promotion.objects[r.attr("data-lineid")].logic.rule.result*-100:0}),n.postFee=0,n.serviceFee=0}),n.t=e.now(),n.stepPayData=e.one("#J_StepPayData")&&e.one("#J_StepPayData").val(),n.isLadderGroup=e.one("#J_IsLadderGroup")&&e.one("#J_IsLadderGroup").val(),n},initFareAndPromo:function(){var t=this.orderData.orders;if(!t)return;var n=this,r={};for(var i in t)t[i].postages&&(r[i.replace("b_","")]=t[i].postages);n.renderFare(r),e.each(n.promotion.objects,function(e,t){var r=n.promotion.logic.data.orders[t];r&&n.promotion.fire(t+":change",{selectedBundle:r.bundles&&r.bundles[r.bundle]||{}})})},renderFare:function(e){var t=this;for(var n in e){var r=t.orders[n];r&&(r.fareUI.render(e[n]),r.fareUI.__data=null)}},isOrderReady:function(){for(var e in this.orders)if(!this.orders[e].itemReady||!this.orders[e].codReady)return console.warn("order %s is not ready",e),!1;return!0},updatePromotionPostFree:function(){var t=this;t.promoData&&e.each(t.promoData.orders,function(e,n){var r=e.bundle,i=e.bundles;r&&i&&i[r]?t.postFree[n]=i[r].freedelivery==1:t.postFree[n]=!1})},buildServiceParams:function(){var t=this,n=t.address.getAddressInfo(),r={},i={},s=t.postFree,o=t.service.serviceLogic.data;return r.divisionCode=n&&n.area&&n.area.value,e.all("#J_OrderTable tbody.J_Shop").each(function(n){var r="b_"+n.attr("data-outorderid"),u={},a={};e.all("tr.item",n).each(function(n){var r={};r.quantity=e.one("input.J_Quantity",n).val();var i=r.itemId=n.attr("data-lineid");r.unitPrice=(e.one("em.J_ItemPrice",n).text()*100).toFixed(0),r.costPrice=e.one("input.J_CostPrice",n)?(e.one("input.J_CostPrice",n).val()*100).toFixed(0):0,r.itemPromotionDis=t.promotion.objects[i]?t.promotion.objects[i].logic.rule.result*-1:0,r.itemPostFree=s[i]?s[i]:!1,r.services=o.orders[i]?o.orders[i].services:{},a[i]=r}),u.shopPromotionDis=t.promotion.objects[r]?t.promotion.objects[r].logic.rule.result*-1:0,u.orderPostFree=s[r]?t.postFree[r]:!1,u.services=o.orders[r]?o.orders[r].services:{},u.items=a,u.fare=t.orders[n.attr("data-outorderid")].fareUI.fareLogic.rule.result,u.sellerId=t.orderData.orders[r].sellerId,i[r]=u}),r.orders=i,r}};return L},{requires:["ajax","json","dom","tc/core/rule","tc/core/profile","tc/cart/order","tc/mods/realPay/ui","tc/mods/submit/cart-ui","tc/mods/addressNew/cartAddress-ui","tc/mods/tools/textDraw/textDraw","tc/mods/promoHint/ui","tc/mods/point/ui","tc/mods/promotions/cart-ui","tc/mods/checkCode/ui","tc/mods/updateCart/ui","tc/mods/winPoints/showWinPoint-ui","tc/core/laterqueue","tc/mods/makePoint/makePoint","tc/mods/pointBuy/cartPointBuy-ui","tc/mods/xcard/ui","tc/mods/payForAnother/cart-ui","tc/mods/recover/cart-recover","tc/mods/nav/ui","tc/mods/stepPay/ui","tc/mods/service/cart-ui","tc/mods/generQRCode/cart-ui","tc/mods/tools/placeholder/placeholder"]})